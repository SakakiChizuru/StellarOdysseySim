<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Odyssey Player Setup</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #181c24; color: #e6eaf3; }
        .form-section { max-width: 1100px; margin-left: 0; margin-right: auto; display: flex; flex-direction: row; gap: 2em; }
        .form-section > div:first-child { flex: none; width: 420px; min-width: 420px; }
        .form-row { display: flex; gap: 1em; margin-bottom: 1em; }
        .form-group { flex: 1; display: flex; flex-direction: column; min-width: 180px; color: #e6eaf3; font-size: 1.08em; }
        .input-group { display: flex; align-items: center; }
        .input-group button {
            width: 2.2em;
            height: 1.6em;
            font-size: 1.1em;
            margin: 0 0.2em;
            border-radius: 4px;
            border: 1px solid #2c3242;
            background: #36405a;
            color: #e6eaf3;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: background 0.2s;
            box-sizing: border-box;
        }
        .input-group button:active {
            background: #2a3142;
        }
        .input-group input[type=number] {
            width: 3.84em;
            height: 1.32em;
            font-size: 1.14em;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #2c3242;
            background: #36405a;
            color: #e6eaf3;
            box-sizing: border-box;
        }
        .clone-modifiers-section {
            flex: none;
            display: grid;
            grid-template-rows: repeat(5, 110px); /* 5 rows for up to 10 clones */
            grid-template-columns: repeat(2, 230px);
            grid-auto-flow: row;
            gap: 0.5em;
            margin-left: 40px;
        }
        .clone-modifiers-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.25em 0.5em 0.15em 0.5em;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 260px;
            min-width: 260px;
            max-width: 260px;
            height: 110px;
            min-height: 110px;
            max-height: 110px;
            box-sizing: border-box;
            font-size: 0.98em;
            color: #e6eaf3;
        }
        .clone-modifiers-block:nth-child(2n) {
            margin-left: 2em;
        }
        .clone-label {
            font-weight: 600;
            margin-bottom: 0.25em;
            text-align: center;
            font-size: 1.04em;
            color: #e6eaf3;
        }
        .clone-field-group {
            display: flex;
            align-items: center;
            gap: 0.15em;
            margin-bottom: 0.15em;
            color: #e6eaf3;
        }
        .clone-field-group label {
            margin-bottom: 0;
            font-size: 0.97em;
            min-width: 90px;
            white-space: nowrap;
            color: #e6eaf3;
        }
        .clone-field-group input[type=number] {
            width: 3.2em;
            height: 1.1em;
            font-size: 0.98em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
            padding-left: 5px;
        }
        .clone-field-group .minus-btn,
        .clone-field-group .plus-btn {
            width: 1.44em;
            height: 1.08em;
            font-size: 0.92em;
            margin: 0 0.08em;
            display: flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        label { margin-bottom: 0.2em; }
        button[type=button], button[type=submit] {
            margin-top: 1em; padding: 0.5em 1em;
            background: #36405a;
            color: #f3f6fa;
            border: 1px solid #4a5a7c;
            font-weight: 600;
            letter-spacing: 0.01em;
            transition: background 0.2s, color 0.2s;
        }
        button[type=button]:hover, button[type=submit]:hover {
            background: #4a5a7c;
            color: #fff;
        }
        .block-label { font-size: 1.22em; font-weight: 700; margin-bottom: 0.5em; color: #f3f6fa; letter-spacing: 0.01em; }
        #playerResult { margin-top: 1.5em; font-size: 1.1em; color: #f3f6fa; }
        @media (max-width: 900px) {
            .form-section { max-width: 100%; }
            .form-row { flex-direction: column; }
            .clone-modifiers-section { margin-left: 0; }
        }
        .input-group .minus-btn,
        .input-group .plus-btn {
            width: 1.73em;
            height: 1.30em;
            font-size: 1.02em;
            margin: 0 0.08em;
            display: flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #weapon_dmg,
        #shield_def {
            width: 5.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        .player-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            margin-bottom: 1em;
        }
        .mob-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            margin-bottom: 1em;
            margin-left: 0em;
            align-self: flex-start;
        }
        #mob_name {
            font-size: 1.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #weapon_ele1,
        #weapon_ele2 {
            font-size: 1.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #shield_ele1,
        #shield_ele2 {
            font-size: 1.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        .battle-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 370px;
            min-width: 370px;
            max-width: 370px;
            margin-bottom: -0.5em;
            margin-top: 5.0em;
            min-height: 230px;
            color: #e6eaf3;
        }
        .optimizer-block {
            background: #23283a !important;
            border-radius: 6px;
            border: 1px solid #2c3242 !important;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 370px;
            min-width: 370px;
            max-width: 370px;
            min-height: 230px;
            color: #e6eaf3;
        }
        footer { color: #b0b6c6; font-size: 0.98em; }
        #n_fights {
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="module">
        import { Player } from './player.js';
        import { Mob } from './mob.js';
        import { Battle } from './battle.js';
        import { CloneModifiers, MobName } from './dataclasses.js';
        import { millify } from './utils.js';
        import { Optimizer } from './optimizer.js';

        // Predefined test values for easy testing
        const DEFAULTS = {
            power: 0,
            precision: 0,
            evasion: 0,
            hull: 0,
            weapon_dmg: 0,
            shield_def: 0,
            n_clones: 1,
            weapon_ele1: "None",
            weapon_ele2: "None",
            shield_ele1: "None",
            shield_ele2: "None",
            vip_status: false,
            mob_name: "Brutes",
            mob_level: 1,
            n_fights: 1000,
            clone_modifiers: [
                { crit: 0, critdmg: 0, dual: 0 }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('playerForm');
            const resultDiv = document.getElementById('playerResult');
            const submitBtn = document.getElementById('submitBtn');
            const cloneModifiersSection = document.getElementById('cloneModifiersSection');
            let cloneModifiers = [];

            // Load saved settings or use defaults
            const savedSettings = localStorage.getItem('stellarOdysseySettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                Object.entries(settings).forEach(([key, value]) => {
                    if (key === 'clone_modifiers') {
                        cloneModifiers = value;
                    } else {
                        const el = document.getElementById(key);
                        if (!el) return;
                        if (el.type === "checkbox") {
                            el.checked = !!value;
                        } else if (el.type === "select-one") {
                            el.value = value || "";
                        } else {
                            el.value = value;
                        }
                    }
                });
                // Render clone modifiers with saved values
                renderCloneModifiers(parseInt(settings.n_clones) || 1);
            } else {
                // Apply DEFAULTS to form fields
                Object.entries(DEFAULTS).forEach(([key, value]) => {
                    const el = document.getElementById(key);
                    if (!el) return;
                    if (el.type === "checkbox") {
                        el.checked = !!value;
                    } else if (el.type === "select-one") {
                        el.value = value || "";
                    } else {
                        el.value = value;
                    }
                });
                cloneModifiers = DEFAULTS.clone_modifiers.map(mod => ({...mod}));
                renderCloneModifiers(parseInt(DEFAULTS.n_clones) || 1);
            }

            // Function to save all settings to localStorage
            function saveSettings() {
                const settings = {
                    // Player stats
                    power: form.power.value,
                    precision: form.precision.value,
                    evasion: form.evasion.value,
                    hull: form.hull.value,
                    weapon_dmg: form.weapon_dmg.value,
                    shield_def: form.shield_def.value,
                    n_clones: form.n_clones.value,
                    weapon_ele1: form.weapon_ele1.value,
                    weapon_ele2: form.weapon_ele2.value,
                    shield_ele1: form.shield_ele1.value,
                    shield_ele2: form.shield_ele2.value,
                    vip_status: form.vip_status.checked,
                    // Mob settings
                    mob_name: form.mob_name.value,
                    mob_level: form.mob_level.value,
                    // Squadron buffs
                    income_boost: form.income_boost?.value || 0,
                    reputation: form.reputation?.value || 0,
                    // Clone modifiers
                    clone_modifiers: cloneModifiers,
                    // Resources calculator
                    resources_per_action: form.resources_per_action?.value || 0,
                    rare_resources_per_action: form.rare_resources_per_action?.value || 0,
                    number_of_drones: form.number_of_drones?.value || 1,
                    dodge_percentage: form.dodge_percentage?.value || 0,
                    rare_drop_increase: form.rare_drop_increase?.value || 0,
                    maneuverability: form.maneuverability?.value || 0,
                    // API key
                    api_key: form.api_key?.value || ''
                };
                localStorage.setItem('stellarOdysseySettings', JSON.stringify(settings));
            }

            // For selects and n_clones, trigger input event to update UI
            const nClonesInput = document.getElementById('n_clones');
            nClonesInput.addEventListener('input', () => {
                let n = Math.min(Math.max(parseInt(nClonesInput.value) || 1, 1), 10);
                nClonesInput.value = n;
                if (cloneModifiers.length > n) {
                    cloneModifiers = cloneModifiers.slice(0, n);
                } else if (cloneModifiers.length < n) {
                    while (cloneModifiers.length < n) {
                        cloneModifiers.push({ crit: 0.0, critdmg: 0.0, dual: 0.0 });
                    }
                }
                renderCloneModifiers(n);
                saveSettings();
            });

            function renderCloneModifiers(n) {
                // Always use cloneModifiers.length as the source of truth
                cloneModifiersSection.innerHTML = '';
                for (let i = 0; i < cloneModifiers.length; i++) {
                    const block = document.createElement('div');
                    block.className = 'clone-modifiers-block';
                    block.innerHTML = `
                        <div class="clone-label">Clone ${i+1}</div>
                        <div class="clone-field-group">
                            <label>Crit. Chance</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="crit">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].crit}" class="clone-input" data-clone="${i}" data-field="crit">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="crit">+</button>
                        </div>
                        <div class="clone-field-group">
                            <label>Crit. Damage</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="critdmg">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].critdmg}" class="clone-input" data-clone="${i}" data-field="critdmg">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="critdmg">+</button>
                        </div>
                        <div class="clone-field-group">
                            <label>Dual Shot</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="dual">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].dual}" class="clone-input" data-clone="${i}" data-field="dual">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="dual">+</button>
                        </div>
                    `;
                    cloneModifiersSection.appendChild(block);
                }
                // Attach event listeners for new buttons and inputs
                const modifyAll = document.getElementById('modifyAllClones')?.checked;
                cloneModifiersSection.querySelectorAll('.minus-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.getAttribute('data-clone'));
                        const field = btn.getAttribute('data-field');
                        let newVal = Math.max(0, (parseFloat(cloneModifiers[idx][field]) || 0) - 1);
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = newVal;
                        } else {
                            cloneModifiers[idx][field] = newVal;
                        }
                        renderCloneModifiers(cloneModifiers.length);
                        saveSettings();
                    });
                });
                cloneModifiersSection.querySelectorAll('.plus-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.getAttribute('data-clone'));
                        const field = btn.getAttribute('data-field');
                        let newVal = Math.min(100, (parseFloat(cloneModifiers[idx][field]) || 0) + 1);
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = newVal;
                        } else {
                            cloneModifiers[idx][field] = newVal;
                        }
                        renderCloneModifiers(cloneModifiers.length);
                        saveSettings();
                    });
                });
                cloneModifiersSection.querySelectorAll('.clone-input').forEach(input => {
                    input.addEventListener('input', () => {
                        const idx = parseInt(input.getAttribute('data-clone'));
                        const field = input.getAttribute('data-field');
                        let val = parseFloat(input.value) || 0;
                        if (val < 0) val = 0;
                        if (val > 100) val = 100;
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = val;
                            renderCloneModifiers(cloneModifiers.length);
                        } else {
                            cloneModifiers[idx][field] = val;
                        }
                        saveSettings();
                    });
                });
            }

            // Handle plus/minus for player fields
            document.querySelectorAll('.minus-btn:not([data-clone])').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const min = parseFloat(input.getAttribute('min')) || 0;
                    let val = parseFloat(input.value) || 0;
                    
                    // Define step values for different fields
                    let step = 10; // default step
                    if (['n_clones', 'number_of_drones'].includes(targetId)) {
                        step = 1;
                    } else if (['precision', 'hull', 'power', 'evasion'].includes(targetId)) {
                        step = 5;
                    } else if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        step = 1;
                    }
                    
                    val = Math.max(min, val - step);
                    // Round to 1 decimal place for percentage fields
                    if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        val = Math.round(val * 10) / 10;
                    }
                    input.value = val;
                    input.dispatchEvent(new Event('input'));
                });
            });
            
            document.querySelectorAll('.plus-btn:not([data-clone])').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const max = parseFloat(input.getAttribute('max')) || Infinity;
                    let val = parseFloat(input.value) || 0;
                    
                    // Define step values for different fields
                    let step = 10; // default step
                    if (['n_clones', 'number_of_drones'].includes(targetId)) {
                        step = 1;
                    } else if (['precision', 'hull', 'power', 'evasion'].includes(targetId)) {
                        step = 5;
                    } else if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        step = 1;
                    }
                    
                    val = Math.min(max, val + step);
                    // Round to 1 decimal place for percentage fields
                    if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        val = Math.round(val * 10) / 10;
                    }
                    input.value = val;
                    input.dispatchEvent(new Event('input'));
                });
            });

            // Simulate button logic
            const simulateBtn = document.getElementById('simulateBtn');
            const battleResultDiv = document.createElement('div');
            battleResultDiv.id = 'battleResult';
            simulateBtn.parentNode.parentNode.parentNode.appendChild(battleResultDiv);
            simulateBtn.addEventListener('click', () => {
                // Gather player fields
                const power = parseInt(form.power.value) || 0;
                const precision = parseInt(form.precision.value) || 0;
                const evasion = parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                const weapon_dmg = parseInt(form.weapon_dmg.value) || 0;
                const shield_def = parseInt(form.shield_def.value) || 0;
                const n_clones = parseInt(form.n_clones.value) || 1;
                const weapon_ele1 = form.weapon_ele1.value || null;
                const weapon_ele2 = form.weapon_ele2.value || null;
                const shield_ele1 = form.shield_ele1.value || null;
                const shield_ele2 = form.shield_ele2.value || null;
                const vip_status = form.vip_status.checked;

                // Gather clone modifiers
                const list_modifiers = cloneModifiers.map(mod =>
                    new CloneModifiers(
                        (parseFloat(mod.crit) || 0) / 100,
                        (parseFloat(mod.critdmg) || 0) / 100,
                        (parseFloat(mod.dual) || 0) / 100
                    )
                );

                // Gather mob fields
                const mob_name = form.mob_name.value;
                const mob_level = parseInt(form.mob_level.value) || 1;
                // MobName enum is uppercase keys
                let mob_enum_key = Object.keys(MobName).find(key => MobName[key] === mob_name);
                const mob = new Mob(MobName[mob_enum_key], mob_level);

                // Number of fights
                let n_fights = parseInt(form.n_fights.value) || 1000;
                if (n_fights < 1) n_fights = 1;
                if (n_fights > 1000000) {
                    n_fights = 1000000;
                    form.n_fights.value = 1000000;
                }

                // Create player
                const player = new Player({
                    power, precision, evasion, hull, weapon_dmg, shield_def, n_clones, vip_status,
                    weapon_ele1, weapon_ele2, shield_ele1, shield_ele2
                });

                // Create and run battle
                const battle = new Battle({ player, mob, list_modifiers, verbose: false });
                const win_chance = battle.repeat_fights(n_fights);

                // Get income boost and reputation values
                const income_boost = parseFloat(form.income_boost?.value || 0) / 100;
                const reputation = parseFloat(form.reputation?.value || 0) / 100;

                // Print result
                const creditsPerHour = battle.get_revenue('hourly', win_chance, income_boost, reputation);
                const creditsPerDay = battle.get_revenue('daily', win_chance, income_boost, reputation);
                const expPerHour = battle.get_experience('hourly', win_chance, reputation);
                const expPerDay = battle.get_experience('daily', win_chance, reputation);
                battleResultDiv.innerHTML = `<b>Win chance:</b> ${(win_chance * 100).toFixed(2)}%<br>` +
                    `<b>Credits per hour:</b> ${millify(creditsPerHour)}/h<br>` +
                    `<b>Credits per day:</b> ${millify(creditsPerDay)}/day<br>` +
                    `<b>Experience per hour:</b> ${millify(expPerHour)}/h<br>` +
                    `<b>Experience per day:</b> ${millify(expPerDay)}/day`;
            });

            // Optimizer logic
            const optimizerBtn = document.getElementById('optimizerBtn');
            const optimizerResultDiv = document.getElementById('optimizerResult');
            optimizerBtn.addEventListener('click', () => {
                // Gather player fields
                const power = parseInt(form.power.value) || 0;
                const precision = parseInt(form.precision.value) || 0;
                const evasion = parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                const weapon_dmg = parseInt(form.weapon_dmg.value) || 0;
                const shield_def = parseInt(form.shield_def.value) || 0;
                const n_clones = parseInt(form.n_clones.value) || 1;
                const weapon_ele1 = form.weapon_ele1.value || null;
                const weapon_ele2 = form.weapon_ele2.value || null;
                const shield_ele1 = form.shield_ele1.value || null;
                const shield_ele2 = form.shield_ele2.value || null;
                const vip_status = form.vip_status.checked;

                // Gather clone modifiers
                const list_modifiers = cloneModifiers.map(mod =>
                    new CloneModifiers(
                        (parseFloat(mod.crit) || 0) / 100,
                        (parseFloat(mod.critdmg) || 0) / 100,
                        (parseFloat(mod.dual) || 0) / 100
                    )
                );

                // Gather mob fields
                const mob_name = form.mob_name.value;
                const mob_level = parseInt(form.mob_level.value) || 1;
                let mob_enum_key = Object.keys(MobName).find(key => MobName[key] === mob_name);
                const mob = new Mob(MobName[mob_enum_key], mob_level);

                // Create player
                const player = new Player({
                    power, precision, evasion, hull, weapon_dmg, shield_def, n_clones, vip_status,
                    weapon_ele1, weapon_ele2, shield_ele1, shield_ele2
                });

                const optimizerFightsInput = document.getElementById('optimizer_n_fights');
                const n_fights = parseInt(optimizerFightsInput.value);
                const optimizer = new Optimizer(player, mob, list_modifiers, n_fights);
                let result;
                result = optimizer.optimize();
                
                if (result && result.bestStats && result.winChance !== undefined) {
                    const [power, precision, evasion, hull] = result.bestStats;
                    const tmp_player = new Player({
                        power,
                        precision,
                        evasion,
                        hull,
                        weapon_dmg: player.weapon_dmg,
                        shield_def: player.shield_def,
                        n_clones: player.n_clones,
                        vip_status: player.vip_status,
                        weapon_ele1: player.weapon_ele1,
                        weapon_ele2: player.weapon_ele2,
                        shield_ele1: player.shield_ele1,
                        shield_ele2: player.shield_ele2
                    });
                    const battle = new Battle({ player: tmp_player, mob: mob, list_modifiers: list_modifiers });
                    
                    // Get income boost and reputation values
                    const income_boost = parseFloat(form.income_boost?.value || 0) / 100;
                    const reputation = parseFloat(form.reputation?.value || 0) / 100;

                    const creditsPerHour = battle.get_revenue('hourly', result.winChance, income_boost, reputation);
                    const creditsPerDay = battle.get_revenue('daily', result.winChance, income_boost, reputation);
                    const expPerHour = battle.get_experience('hourly', result.winChance, reputation);
                    const expPerDay = battle.get_experience('daily', result.winChance, reputation);
                    
                    // Update the stats
                    document.getElementById('opt_power').textContent = power;
                    document.getElementById('opt_precision').textContent = precision;
                    document.getElementById('opt_evasion').textContent = evasion;
                    document.getElementById('opt_hull').textContent = hull;
                    
                    // Update the results
                    document.getElementById('opt_win_chance').textContent = `${(result.winChance * 100).toFixed(2)}%`;
                    document.getElementById('opt_credits_hour').textContent = `${millify(creditsPerHour)}/h`;
                    document.getElementById('opt_credits_day').textContent = `${millify(creditsPerDay)}/day`;
                    document.getElementById('opt_exp_hour').textContent = `${millify(expPerHour)}/h`;
                    document.getElementById('opt_exp_day').textContent = `${millify(expPerDay)}/day`;

                    // Add Import button next to Optimize
                    let importBtn = document.getElementById('importOptimizedBtn');
                    if (!importBtn) {
                        importBtn = document.createElement('button');
                        importBtn.id = 'importOptimizedBtn';
                        importBtn.type = 'button';
                        importBtn.textContent = 'Import';
                        optimizerBtn.parentNode.insertBefore(importBtn, optimizerBtn.nextSibling);
                    }
                    importBtn.style.display = 'inline-block';
                    importBtn.onclick = () => {
                        form.power.value = power;
                        form.precision.value = precision;
                        form.evasion.value = evasion;
                        form.hull.value = hull;
                    };
                } else {
                    // Reset all values to "-"
                    document.getElementById('opt_power').textContent = '-';
                    document.getElementById('opt_precision').textContent = '-';
                    document.getElementById('opt_evasion').textContent = '-';
                    document.getElementById('opt_hull').textContent = '-';
                    document.getElementById('opt_win_chance').textContent = '-';
                    document.getElementById('opt_credits_hour').textContent = '-';
                    document.getElementById('opt_credits_day').textContent = '-';
                    document.getElementById('opt_exp_hour').textContent = '-';
                    document.getElementById('opt_exp_day').textContent = '-';
                    
                    let importBtn = document.getElementById('importOptimizedBtn');
                    if (importBtn) importBtn.style.display = 'none';
                }
            });

            // Add event listeners to save settings when values change
            form.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', saveSettings);
                if (element.type === 'number' || element.type === 'text') {
                    element.addEventListener('input', saveSettings);
                }
            });

            // For number inputs, also save on input event for immediate feedback
            form.querySelectorAll('input[type="number"]').forEach(element => {
                element.addEventListener('input', saveSettings);
            });

            // Add event listeners for all minus/plus buttons
            document.querySelectorAll('.minus-btn, .plus-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    if (targetId) {
                        const input = document.getElementById(targetId);
                        if (input) {
                            input.dispatchEvent(new Event('input'));
                            saveSettings();
                        }
                    }
                });
            });

            // Modify the clone modifiers event listeners to save settings
            function addCloneModifierListeners() {
                cloneModifiersSection.querySelectorAll('.minus-btn, .plus-btn, .clone-input').forEach(element => {
                    element.addEventListener('change', saveSettings);
                    if (element.classList.contains('clone-input')) {
                        element.addEventListener('input', saveSettings);
                    }
                });
            }

            // Update the renderCloneModifiers function to add listeners
            const originalRenderCloneModifiers = renderCloneModifiers;
            renderCloneModifiers = function(n) {
                originalRenderCloneModifiers(n);
                addCloneModifierListeners();
            };
            
            
            // Add API import functionality
            const importBtn = document.getElementById('importBtn');
            const apiKeyInput = document.getElementById('api_key');
            
            async function fetchUserData(apiKey) {
                try {
                    const response = await axios({
                        method: 'get',
                        url: `https://api.stellarodyssey.app/api/public/user?apikey=${apiKey}`,
                        headers: {
                            'Accept': 'application/json'
                        },
                        timeout: 5000
                    });
                    return response.data;
                } catch (error) {

                    let errorMessage = 'Failed to fetch user data. ';
                    
                    if (error.response) {
                        if (error.response.status === 401) {
                            errorMessage += 'Invalid API key.';
                        } else if (error.response.status === 404) {
                            errorMessage += 'User not found.';
                        } else {
                            errorMessage += `Server responded with status ${error.response.status}.`;
                        }
                    } else if (error.code === 'ECONNABORTED') {
                        errorMessage += 'Request timed out.';
                    } else if (error.code === 'ERR_NETWORK') {
                        if (error.message.includes('CORS')) {
                            errorMessage += 'CORS error: The API server is not configured to allow requests from this domain. Please contact the API administrators.';
                        } else {
                            errorMessage += 'Network error. Please check your internet connection.';
                        }
                    } else {
                        errorMessage += error.message;
                    }
                    
                    throw new Error(errorMessage);
                }
            }

            function updateFormWithUserData(userData) {
                const data = userData.data;
                
                // Update form fields with API data
                if (data.stats) {
                    form.power.value = data.stats.power || 0;
                    form.precision.value = data.stats.precision || 0;
                    form.evasion.value = data.stats.evasion || 0;
                    form.hull.value = data.stats.hull || 0;
                }

                // Update ship data
                if (data.ship) {
                    if (data.ship.weapon) {
                        form.weapon_dmg.value = data.ship.weapon.value || 0;
                        if (data.ship.weapon.bonuses && data.ship.weapon.bonuses.length > 0) {
                            form.weapon_ele1.value = data.ship.weapon.bonuses[0].charAt(0).toUpperCase() + data.ship.weapon.bonuses[0].slice(1);
                            if (data.ship.weapon.bonuses.length > 1) {
                                form.weapon_ele2.value = data.ship.weapon.bonuses[1].charAt(0).toUpperCase() + data.ship.weapon.bonuses[1].slice(1);
                            } else {
                                form.weapon_ele2.value = '';
                            }
                        } else {
                            form.weapon_ele1.value = '';
                            form.weapon_ele2.value = '';
                        }
                    }

                    if (data.ship.shield) {
                        form.shield_def.value = data.ship.shield.value || 0;
                        if (data.ship.shield.bonuses && data.ship.shield.bonuses.length > 0) {
                            form.shield_ele1.value = data.ship.shield.bonuses[0].charAt(0).toUpperCase() + data.ship.shield.bonuses[0].slice(1);
                            if (data.ship.shield.bonuses.length > 1) {
                                form.shield_ele2.value = data.ship.shield.bonuses[1].charAt(0).toUpperCase() + data.ship.shield.bonuses[1].slice(1);
                            } else {
                                form.shield_ele2.value = '';
                            }
                        } else {
                            form.shield_ele1.value = '';
                            form.shield_ele2.value = '';
                        }
                    }
                }

                // Update VIP status
                form.vip_status.checked = data.premium || false;

                // Update number of clones and clone modifiers
                if (data.clones && data.clones.length > 0) {
                    form.n_clones.value = data.clones.length;
                    cloneModifiers = data.clones.map(clone => ({
                        crit: clone.critical_chance || 0,
                        critdmg: clone.critical_damage || 0,
                        dual: clone.dual_shot || 0
                    }));
                }

                // Update current mob and level
                if (data.actions) {
                    if (data.actions.currentNpc) {
                        form.mob_name.value = data.actions.currentNpc.charAt(0).toUpperCase() + data.actions.currentNpc.slice(1);
                    }
                    if (data.actions.currentNpcLevel) {
                        form.mob_level.value = data.actions.currentNpcLevel;
                    }
                }

                // Handle spacestation incomeboost
                if (data.spacestation && data.spacestation.incomeboost) {
                    form.income_boost.value = data.spacestation.incomeboost;
                } else {
                    form.income_boost.value = 0;
                }

                // Handle reputation
                if (data.reputation !== null && data.reputation !== undefined) {
                    form.reputation.value = (data.reputation * 0.2).toFixed(1);
                } else {
                    form.reputation.value = 0;
                }

                // Render clone modifiers with the new data
                renderCloneModifiers(parseInt(form.n_clones.value) || 1);
                
                const nClonesInput = document.getElementById('n_clones');
                nClonesInput.dispatchEvent(new Event('input'));
                
                saveSettings();
            }

            importBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('Please enter your API key');
                    return;
                }

                try {
                    importBtn.disabled = true;
                    importBtn.textContent = 'Importing...';

                    const userData = await fetchUserData(apiKey);
                    updateFormWithUserData(userData);
                    
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import';
                } catch (error) {
                    alert(error.message);
                    
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import';
                }
            });
   
        });
    </script>
</head>
<body>
    <div style="font-size: 1.7em; font-weight: 600; margin-bottom: 1.2em; letter-spacing: 0.01em;">Stellar Odyssey Simulator and Optimizer</div>
    <form id="playerForm" class="form-section" autocomplete="off" style="display: flex; flex-direction: row; gap: 2em;">
        <div style="flex: 3;">
            <div class="player-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                <div class="block-label">Player</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="power">Power:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="power">-</button>
                            <input type="number" id="power" name="power" value="0" min="0">
                            <button type="button" class="plus-btn" data-target="power">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="precision">Precision:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="precision">-</button>
                            <input type="number" id="precision" name="precision" value="0" min="0">
                            <button type="button" class="plus-btn" data-target="precision">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="evasion">Evasion:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="evasion">-</button>
                            <input type="number" id="evasion" name="evasion" value="0" min="0">
                            <button type="button" class="plus-btn" data-target="evasion">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="hull">Hull:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="hull">-</button>
                            <input type="number" id="hull" name="hull" value="0" min="0">
                            <button type="button" class="plus-btn" data-target="hull">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="weapon_dmg">Weapon Damage:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="weapon_dmg">-</button>
                            <input type="number" id="weapon_dmg" name="weapon_dmg" value="0" min="0">
                            <button type="button" class="plus-btn" data-target="weapon_dmg">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="shield_def">Shield Defense:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="shield_def">-</button>
                            <input type="number" id="shield_def" name="shield_def" value="0" min="0">
                            <button type="button" class="plus-btn" data-target="shield_def">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="weapon_ele1">Weapon Modification 1:</label>
                        <select id="weapon_ele1" name="weapon_ele1">
                            <option value="">None</option>
                            <option value="Chemical">Chemical</option>
                            <option value="Electromagnetic">Electromagnetic</option>
                            <option value="Energy">Energy</option>
                            <option value="Explosive">Explosive</option>
                            <option value="Incendiary">Incendiary</option>
                            <option value="Kinetic">Kinetic</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weapon_ele2">Weapon Modification 2:</label>
                        <select id="weapon_ele2" name="weapon_ele2">
                            <option value="">None</option>
                            <option value="Chemical">Chemical</option>
                            <option value="Electromagnetic">Electromagnetic</option>
                            <option value="Energy">Energy</option>
                            <option value="Explosive">Explosive</option>
                            <option value="Incendiary">Incendiary</option>
                            <option value="Kinetic">Kinetic</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="shield_ele1">Shield Modification 1:</label>
                        <select id="shield_ele1" name="shield_ele1">
                            <option value="">None</option>
                            <option value="Chemical">Chemical</option>
                            <option value="Electromagnetic">Electromagnetic</option>
                            <option value="Energy">Energy</option>
                            <option value="Explosive">Explosive</option>
                            <option value="Incendiary">Incendiary</option>
                            <option value="Kinetic">Kinetic</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="shield_ele2">Shield Modification 2:</label>
                        <select id="shield_ele2" name="shield_ele2">
                            <option value="">None</option>
                            <option value="Chemical">Chemical</option>
                            <option value="Electromagnetic">Electromagnetic</option>
                            <option value="Energy">Energy</option>
                            <option value="Explosive">Explosive</option>
                            <option value="Incendiary">Incendiary</option>
                            <option value="Kinetic">Kinetic</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_clones">Number of Clones:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="n_clones">-</button>
                            <input type="number" id="n_clones" name="n_clones" value="1" min="1" max="10">
                            <button type="button" class="plus-btn" data-target="n_clones">+</button>
                        </div>
                    </div>
                    <div class="form-group" style="align-items: flex-start; justify-content: flex-end;">
                        <label for="vip_status" style="margin-bottom: 0;">
                            <input type="checkbox" id="vip_status" name="vip_status">
                            VIP Status
                        </label>
                    </div>
                </div>
            </div>
            <div class="mob-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                <div class="block-label">Mob</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="mob_name">Mob Name:</label>
                        <select id="mob_name" name="mob_name">
                            <option value="Brutes">Brutes</option>
                            <option value="Dusters">Dusters</option>
                            <option value="Machiners">Machiners</option>
                            <option value="Toxoids">Toxoids</option>
                            <option value="Scorchers">Scorchers</option>
                            <option value="Glacials">Glacials</option>
                            <option value="Specters">Specters</option>
                            <option value="Miners">Miners</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mob_level">Level:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="mob_level">-</button>
                            <input type="number" id="mob_level" name="mob_level" value="1" min="1">
                            <button type="button" class="plus-btn" data-target="mob_level">+</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mob-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                <div class="block-label">Squadron Buffs</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="income_boost">Space station:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="income_boost">-</button>
                            <input type="number" id="income_boost" name="income_boost" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="income_boost">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reputation">Reputation:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="reputation">-</button>
                            <input type="number" id="reputation" name="reputation" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="reputation">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="display: flex; flex-direction: row; align-items: flex-start;">
            <div style="position: relative; width: fit-content;">
                <div style="position: absolute; left: 180px; top: -2.1em; z-index: 2;">
                    <label style="font-size: 1.08em; display: flex; align-items: center; color: #e6eaf3; background: #23283a; padding: 0.1em 0.7em 0.1em 0.5em; border-radius: 5px; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);">
                        <input type="checkbox" id="modifyAllClones" style="margin-right: 0.5em;"> Modify all clones together
                    </label>
                </div>
                <div id="cloneModifiersSection" class="clone-modifiers-section"></div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-start; margin-left: 7.5em;">
                <div class="api-block" style="margin-top: 0; margin-left: 5px; min-height: 110px; max-height: 110px; width: 450px; min-width: 450px; max-width: 450px; background: #23283a; border-radius: 6px; border: 1px solid #2c3242; padding: 0.7em 1.2em 0.5em 1.2em; box-sizing: border-box;">
                    <div class="block-label">Import data
                        <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Import your player, mob and clone stats using your API key. This will automatically fill in all your current stats. Your API key is located in Settings">ⓘ</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="api_key">API Key:</label>
                            <input type="text" id="api_key" name="api_key" style="width: 150%; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.2em;">
                        </div>
                        <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: 110px;">
                            <button id="importBtn" type="button">Import</button>
                        </div>
                    </div>
                </div>
                <div class="battle-block" style="margin-top: 1.0em; margin-left: 5px; min-height: 210px; max-height: 210px;width: 350px; min-width: 350px; max-width: 350px">
                    <div class="block-label">Battle Simulation
                        <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Run a battle simulation with the current configuration. The simulation will execute the specified number of battles (up to 1,000,000) to calculate win probability and resource gains.">ⓘ</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="n_fights">Number of fights:</label>
                            <input type="number" id="n_fights" name="n_fights" value="10000" min="1" max="1000000" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                        <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: -30px;">
                            <button id="simulateBtn" type="button">Simulate</button>
                        </div>
                    </div>
                </div>
                <div class="optimizer-block" style="margin-top: 1.5em; margin-left: 5px; width: 500px; min-width: 500px; max-width: 500px; min-height: 210px;">
                    <div class="block-label">Optimizer
                        <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Find the optimal stat distribution for your current configuration. The optimizer will test various stat combinations using the specified number of simulations (up to 1,000,000). Higher values provide more accurate results but significantly increase computation time and may temporarily freeze the interface. Consider starting with a lower number and increasing it if needed.">ⓘ</span>
                        <span style="color: #ff4f4f; margin-left: 10px; font-size: 0.85em; font-weight: normal;">Optimizer is currently unreliable for mob levels > 150. Use with caution.</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="optimizer_n_fights">Number of fights:</label>
                            <input type="number" id="optimizer_n_fights" name="optimizer_n_fights" value="5000" min="1" max="1000000" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                        <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: -130px; display: flex; flex-direction: row; align-items: center;">
                            <button id="optimizerBtn" type="button">Optimize</button>
                            <button id="importOptimizedBtn" type="button" style="display: none; margin-left: 20px;">Import</button>
                        </div>
                    </div>
                    <div id="optimizerResult" style="display: flex; flex-direction: row; gap: 2em; margin-top: 1em;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.2em 1.2em; width: 140px; font-size: 1em;">
                            <div><b>Power</b><br><span id="opt_power">-</span></div>
                            <div><b>Precision</b><br><span id="opt_precision">-</span></div>
                            <div><b>Evasion</b><br><span id="opt_evasion">-</span></div>
                            <div><b>Hull</b><br><span id="opt_hull">-</span></div>
                        </div>
                        <div style="font-size: 0.98em;">
                            <div><b>Win chance:</b> <span id="opt_win_chance">-</span></div>
                            <div><b>Credits per hour:</b> <span id="opt_credits_hour">-</span></div>
                            <div><b>Credits per day:</b> <span id="opt_credits_day">-</span></div>
                            <div><b>Experience per hour:</b> <span id="opt_exp_hour">-</span></div>
                            <div><b>Experience per day:</b> <span id="opt_exp_day">-</span></div>
                        </div>
                    </div>
                </div>
                <div class="optimizer-block" style="margin-top: 1.0em; margin-left: 5px; width: 500px; min-width: 500px; max-width: 500px; min-height: 210px; position: relative;">
                    <div style="position: absolute; top: 0.5em; right: 1em; text-align: left; font-size: 0.75em; color: #b0b6c6; line-height: 1.2;">
                        For a more precise resources<br>
                        calculator, see this <a href="https://docs.google.com/spreadsheets/d/1DCpkdBsHL_dqa_Fv13k3M1iKVuBCa4vXbfTjToQ64G8/edit?gid=1892479921#gid=1892479921" target="_blank" style="color: #4fa3ff; text-decoration: none;">Google Sheet</a>
                    </div>
                    <div class="block-label">Resources Calculator
                        <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Calculate resource gathering rates and time to reach specific goals based on your current setup.
• 'Resources' and 'Rare resources' per action refer to what you are currently gathering on your current planet
• 'Additional dodge' and 'Additional rare resource drop' depend only on Laser and Sensor modifications
• 'Avg. maneuverability' is the average Maneuverability across all your drones">ⓘ</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="resources_per_action">Resources per action:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="resources_per_action">-</button>
                                <input type="number" id="resources_per_action" name="resources_per_action" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <button type="button" class="plus-btn" data-target="resources_per_action">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="rare_resources_per_action">Rare res per action:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="rare_resources_per_action">-</button>
                                <input type="number" id="rare_resources_per_action" name="rare_resources_per_action" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <button type="button" class="plus-btn" data-target="rare_resources_per_action">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="number_of_drones">Number of drones:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="number_of_drones">-</button>
                                <input type="number" id="number_of_drones" name="number_of_drones" value="1" min="1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <button type="button" class="plus-btn" data-target="number_of_drones">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dodge_percentage">Additional dodge:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="dodge_percentage">-</button>
                                <input type="number" id="dodge_percentage" name="dodge_percentage" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <span style="margin: 0 0.2em;">%</span>
                                <button type="button" class="plus-btn" data-target="dodge_percentage">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rare_drop_increase">Additional rare res drop:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="rare_drop_increase">-</button>
                                <input type="number" id="rare_drop_increase" name="rare_drop_increase" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <span style="margin: 0 0.2em;">%</span>
                                <button type="button" class="plus-btn" data-target="rare_drop_increase">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="maneuverability">Avg. maneuverability:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="maneuverability">-</button>
                                <input type="number" id="maneuverability" name="maneuverability" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <span style="margin: 0 0.2em;">%</span>
                                <button type="button" class="plus-btn" data-target="maneuverability">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: 0;">
                            <button id="calculateResourcesBtn" type="button">Calculate</button>
                        </div>
                    </div>
                    <div id="resourcesResult" style="display: flex; flex-direction: row; gap: 2em; margin-top: 1em;">
                        <div style="font-size: 0.98em;">
                            <div><b>Resources per hour:</b> <span id="resources_per_hour">-</span></div>
                            <div><b>Rare resources per hour:</b> <span id="rare_resources_per_hour">-</span></div>
                            <div><b>Hours necessary to gather 32M resources:</b> <span id="hours_to_32m">-</span></div>
                            <div><b>Hours necessary to gather 800k rare resources:</b> <span id="days_to_800k">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <div id="playerResult"></div>
    <footer style="margin-top: -2.5em; font-size: 1em; color: #928e8e; text-align: left;">
        <span>Proudly made by anfneub</span>
        <span style="margin-left: 2.5em;" id="lastUpdated"></span>
        <span style="margin-left: 2.5em;">Space Odyssey Version 1.0.16 2025-05-25</span>
        <span style="margin-left: 2.5em; cursor: pointer; color: #4fa3ff; text-decoration: underline;" id="changelogLink">Changelog</span>
    </footer>
    <script>
        // Set last updated date/time
        const lastUpdated = document.getElementById('lastUpdated');
        if (lastUpdated) {
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            const dateStr = "2025-05-25";
            const timeStr = "11:50";
            lastUpdated.textContent = `Last updated: ${dateStr} ${timeStr}`;
        }
    </script>
    <!-- Changelog Modal -->
    <div id="changelogModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
      <div style="background:#222; color:#fff; padding:1.5em; border-radius:10px; max-width:650px; width:117vw; max-width:65vw; max-height:70vh; overflow:auto; box-shadow:0 4px 32px #000; position:relative;">
        <button id="closeChangelog" style="position:absolute; top:0.5em; right:0.5em; background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2 style="margin-top:0;">Changelog</h2>
        <div id="changelogContent" style="white-space:pre-wrap; background:#181818; padding:1em; border-radius:6px; max-height:50vh; overflow:auto; font-size:1em; font-family:inherit;">Loading...</div>
      </div>
    </div>
    <script>
    document.getElementById('changelogLink').addEventListener('click', function() {
      const modal = document.getElementById('changelogModal');
      modal.style.display = 'flex';
      fetch('changelog.txt')
        .then(r => r.text())
        .then(txt => {
          // Format lines starting with '-' as list items
          const lines = txt.split('\n');
          let html = '';
          let inList = false;
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (/^\s*- /.test(line)) {
              if (!inList) { html += '<ul style="margin:0 0 0 1.5em; padding-left:1.2em;">'; inList = true; }
              html += '<li style="margin-bottom:0.2em;">' + line.replace(/^\s*- /, '') + '</li>';
            } else {
              if (inList) { html += '</ul>'; inList = false; }
              // If the line is not empty, wrap in <div>, else add a blank line
              html += line.trim() ? '<div>' + line + '</div>' : '<div style="height:0.7em;"></div>';
            }
          }
          if (inList) html += '</ul>';
          document.getElementById('changelogContent').innerHTML = html;
        })
        .catch(() => {
          document.getElementById('changelogContent').textContent = 'Could not load changelog.';
        });
    });
    document.getElementById('closeChangelog').addEventListener('click', function() {
      document.getElementById('changelogModal').style.display = 'none';
    });
    // Optional: close modal on outside click
    document.getElementById('changelogModal').addEventListener('click', function(e) {
      if (e.target === this) this.style.display = 'none';
    });
    </script>
    <script src="script.js"></script>
</body>
</html> 
