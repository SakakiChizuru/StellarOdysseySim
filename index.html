<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>恒星奥德赛加点配置模拟器</title>
    <!-- Rajdhani -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600&display=swap" rel="stylesheet">
    <link rel="icon" href="https://game.stellarodyssey.app/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: "Rajdhani", Tahoma, Arial, sans-serif;
            margin: 2em;
            background: #181c24;
            color: #e6eaf3;
        }
        .form-section {
            max-width: 1100px;
            margin-left: 0;
            margin-right: auto;
            display: flex;
            flex-direction: row;
            gap: 2em;
        }

        /* Tab styles */
        .tab-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #23283a;
            border-top: 1px solid #2c3242;
            display: flex;
            padding: 0.3em 2em;
            z-index: 1000;
        }
        .tab {
            padding: 0.8em 1.5em;
            background: #36405a;
            border: 1px solid #2c3242;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 0.2em;
            cursor: pointer;
            color: #e6eaf3;
            transition: background 0.2s;
        }
        .tab:hover {
            background: #4a5a7c;
        }
        .tab.active {
            background: #23283a;
            border-bottom: 1px solid #23283a;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
            margin-bottom: 3em; /* Space for tabs */
        }
        .tab-content.active {
            display: block;
        }
        /* End tab styles */
        [type="number" i],
        [type="text" i] {
            font-family: "Rajdhani", Tahoma, Arial, sans-serif;
            padding-block: 1px;
            padding-inline: 2px;
        }
        .form-section > div:first-child {
            flex: none;
            width: 420px;
            min-width: 420px;
        }
        .form-row {
            display: flex;
            gap: 1em;
            margin-bottom: 1em;
        }
        .form-group {
            font-family: "Rajdhani", Tahoma, Arial, sans-serif;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 180px;
            color: #e6eaf3;
            font-size: 1.08em;
        }
        .input-group {
            display: flex;
            align-items: center;
        }
        .input-group button {
            width: 2.2em;
            height: 1.6em;
            font-size: 1.1em;
            margin: 0 0.2em;
            border-radius: 4px;
            border: 1px solid #2c3242;
            background: #36405a;
            color: #e6eaf3;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: background 0.2s;
            box-sizing: border-box;
        }
        .input-group button:active {
            background: #2a3142;
        }
        .input-group input[type="number"] {
            font-family: "Rajdhani", Tahoma, Arial, sans-serif;
            width: 3.84em;
            height: 1.32em;
            font-size: 1.14em;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #2c3242;
            background: #36405a;
            color: #e6eaf3;
            box-sizing: border-box;
        }
        .clone-modifiers-section {
            font-family: "Rajdhani", Tahoma, Arial, sans-serif;
            flex: none;
            display: grid;
            grid-template-rows: repeat(5, 110px); /* 5 rows for up to 10 clones */
            grid-template-columns: repeat(2, 230px);
            grid-auto-flow: row;
            gap: 0.5em;
            margin-left: 40px;
        }
        .clone-modifiers-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.25em 0.5em 0.15em 0.5em;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 260px;
            min-width: 260px;
            max-width: 260px;
            height: 110px;
            min-height: 110px;
            max-height: 110px;
            box-sizing: border-box;
            font-size: 0.98em;
            color: #e6eaf3;
        }
        .clone-modifiers-block:nth-child(2n) {
            margin-left: 2em;
        }
        .clone-label {
            font-weight: 600;
            margin-bottom: 0.25em;
            text-align: center;
            font-size: 1.04em;
            color: #e6eaf3;
        }
        .clone-field-group {
            display: flex;
            align-items: center;
            gap: 0.15em;
            margin-bottom: 0.15em;
            color: #e6eaf3;
        }
        .clone-field-group label {
            margin-bottom: 0;
            font-size: 0.97em;
            min-width: 90px;
            white-space: nowrap;
            color: #e6eaf3;
        }
        .clone-field-group input[type="number"] {
            width: 3.2em;
            height: 1.1em;
            font-size: 0.98em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
            padding-left: 5px;
        }
        .clone-field-group .minus-btn,
        .clone-field-group .plus-btn {
            width: 1.44em;
            height: 1.08em;
            font-size: 0.92em;
            margin: 0 0.08em;
            display: flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        label {
            margin-bottom: 0.2em;
        }
        button[type="button"],
        button[type="submit"] {
            margin-top: 1em;
            padding: 0.5em 1em;
            background: #36405a;
            color: #f3f6fa;
            border: 1px solid #4a5a7c;
            font-weight: 600;
            letter-spacing: 0.01em;
            transition: background 0.2s, color 0.2s;
        }
        button[type="button"]:hover,
        button[type="submit"]:hover {
            background: #4a5a7c;
            color: #fff;
        }

        a {
            color: #eaeaea;
            text-decoration: none;
        }
        .block-label {
            font-family: "Rejdhani", Tahoma, Arial, sans-serif;
            font-size: 1.22em;
            font-weight: 700;
            margin-bottom: 0.5em;
            color: #f3f6fa;
            letter-spacing: 0.01em;
        }
        #playerResult {
            margin-top: 1.5em;
            font-size: 1.1em;
            color: #f3f6fa;
        }
        @media (max-width: 900px) {
            .form-section {
                max-width: 100%;
            }
            .form-row {
                flex-direction: column;
            }
            .clone-modifiers-section {
                margin-left: 0;
            }
        }
        .input-group .minus-btn,
        .input-group .plus-btn {
            font-family: "Rejdhani", Tahoma, Arial, sans-serif;
            width: 1.73em;
            height: 1.3em;
            font-size: 1.02em;
            margin: 0 0.08em;
            display: flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #weapon_dmg,
        #shield_def {
            width: 5em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        .player-block {
            font-family: "Rejdhani", Tahoma, Arial, sans-serif;
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            margin-bottom: 1em;
        }
        .mob-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            margin-bottom: 1em;
            margin-left: 0em;
            align-self: flex-start;
        }
        #mob_name {
            font-size: 1em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #weapon_ele1,
        #weapon_ele2 {
            font-size: 1em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #shield_ele1,
        #shield_ele2 {
            font-size: 1em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        .battle-block {
            font-family: "Rejdhani", Tahoma, Arial, sans-serif;
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 370px;
            min-width: 370px;
            max-width: 370px;
            margin-bottom: -0.5em;
            margin-top: 5em;
            min-height: 230px;
            color: #e6eaf3;
        }
        .optimizer-block {
            font-family: "Rejdhani", Tahoma, Arial, sans-serif;
            background: #23283a !important;
            border-radius: 6px;
            border: 1px solid #2c3242 !important;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 370px;
            min-width: 370px;
            max-width: 370px;
            min-height: 230px;
            color: #e6eaf3;
            display: flex;
            flex-direction: column;
        }
        footer {
            position: fixed;
            bottom: 3.2em;
            left: 2em;
            font-size: 1em;
            color: #928e8e;
            text-align: left;
            z-index: 999;
            background: #181c24;
            padding: 0.5em 0;
        }
        div#optimizerResultInfo, div#opt_result {
            font-family: 'Rajdhani', Tahoma, Arial, sans-serif;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="module">
        import { Player } from './player.js';
        import { Mob } from './mob.js';
        import { Battle } from './battle.js';
        import { CloneModifiers, MobName } from './dataclasses.js';
        import { millify } from './utils.js';
        import { Optimizer } from './optimizer.js';

        // Predefined test values for easy testing
        const DEFAULTS = {
            power: 0,
            precision: 0,
            evasion: 0,
            hull: 0,
            weapon_dmg: 0,
            shield_def: 0,
            n_clones: 1,
            weapon_ele1: "None",
            weapon_ele2: "None",
            shield_ele1: "None",
            shield_ele2: "None",
            vip_status: false,
            mob_name: "Brutes",
            mob_level: 1,
            n_fights: 1000,
            clone_modifiers: [
                { crit: 0, critdmg: 0, dual: 0 }
            ],
            // 2025-06-06 Added available points
            available: 0
        };

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('playerForm');
            const resultDiv = document.getElementById('playerResult');
            const submitBtn = document.getElementById('submitBtn');
            const cloneModifiersSection = document.getElementById('cloneModifiersSection');
            let cloneModifiers = [];

            // Function to save all settings to localStorage
            function saveSettings() {
                const settings = {
                    // Player stats
                    power: form.power.value,
                    precision: form.precision.value,
                    evasion: form.evasion.value,
                    hull: form.hull.value,
                    // 2025-06-06 Added available points
                    available: form.available.value || 0,
                    weapon_dmg: form.weapon_dmg.value,
                    shield_def: form.shield_def.value,
                    n_clones: form.n_clones.value,
                    weapon_ele1: form.weapon_ele1.value,
                    weapon_ele2: form.weapon_ele2.value,
                    shield_ele1: form.shield_ele1.value,
                    shield_ele2: form.shield_ele2.value,
                    vip_status: form.vip_status.checked,
                    // Mob settings
                    mob_name: form.mob_name.value,
                    mob_level: form.mob_level.value,
                    // Squadron buffs
                    income_boost: form.income_boost?.value || 0,
                    reputation: form.reputation?.value || 0,
                    // Clone modifiers
                    clone_modifiers: cloneModifiers,
                    // Resources calculator
                    resources_per_action: document.getElementById('resources_per_action').value,
                    rare_resources_per_action: document.getElementById('rare_resources_per_action').value,
                    number_of_drones: document.getElementById('number_of_drones').value,
                    dodge_percentage: document.getElementById('dodge_percentage').value,
                    rare_drop_increase: document.getElementById('rare_drop_increase').value,
                    maneuverability: document.getElementById('maneuverability').value,
                    // Optimizer settings
                    optimizer_target: document.querySelector('input[name="optimize_target"]:checked').value,
                    optimizer_htk: document.getElementById('optimizer_htk').value,
                    optimizer_htd: document.getElementById('optimizer_htd').value,
                    // API key
                    api_key: form.api_key?.value || '',
                    // 2025-06-07 Add fill stat after optimization
                    optimize_fill_after: document.getElementById('optimize_fill_after')?.checked || false
                };
                localStorage.setItem('stellarOdysseySettings', JSON.stringify(settings));
            }

            // Load saved settings or use defaults
            const savedSettings = localStorage.getItem('stellarOdysseySettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                Object.entries(settings).forEach(([key, value]) => {
                    if (key === 'clone_modifiers') {
                        cloneModifiers = value;
                    } else if (key === 'optimizer_target') {
                        const radio = document.querySelector(`input[name="optimize_target"][value="${value}"]`);
                        if (radio) radio.checked = true;
                    } else {
                        const el = document.getElementById(key);
                        if (!el) return;
                        if (el.type === "checkbox") {
                            el.checked = !!value;
                        } else if (el.type === "select-one") {
                            el.value = value || "";
                        } else {
                            el.value = value;
                        }
                    }
                });
                // Render clone modifiers with saved values
                renderCloneModifiers(parseInt(settings.n_clones) || 1);
            } else {
                // Apply DEFAULTS to form fields
                Object.entries(DEFAULTS).forEach(([key, value]) => {
                    const el = document.getElementById(key);
                    if (!el) return;
                    if (el.type === "checkbox") {
                        el.checked = !!value;
                    } else if (el.type === "select-one") {
                        el.value = value || "";
                    } else {
                        el.value = value;
                    }
                });
                cloneModifiers = DEFAULTS.clone_modifiers.map(mod => ({...mod}));
                renderCloneModifiers(parseInt(DEFAULTS.n_clones) || 1);
            }

            // For selects and n_clones, trigger input event to update UI
            const nClonesInput = document.getElementById('n_clones');
            nClonesInput.addEventListener('input', () => {
                let n = Math.min(Math.max(parseInt(nClonesInput.value) || 1, 1), 10);
                nClonesInput.value = n;
                if (cloneModifiers.length > n) {
                    cloneModifiers = cloneModifiers.slice(0, n);
                } else if (cloneModifiers.length < n) {
                    while (cloneModifiers.length < n) {
                        cloneModifiers.push({ crit: 0.0, critdmg: 0.0, dual: 0.0 });
                    }
                }
                renderCloneModifiers(n);
                saveSettings();
            });

            function renderCloneModifiers(n) {
                // Always use cloneModifiers.length as the source of truth
                cloneModifiersSection.innerHTML = '';
                for (let i = 0; i < cloneModifiers.length; i++) {
                    const block = document.createElement('div');
                    block.className = 'clone-modifiers-block';
                    block.innerHTML = `
                        <div class="clone-label">克隆体 ${i+1}</div>
                        <div class="clone-field-group">
                            <label>暴击率</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="crit">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].crit}" class="clone-input" data-clone="${i}" data-field="crit">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="crit">+</button>
                        </div>
                        <div class="clone-field-group">
                            <label>暴击伤害</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="critdmg">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].critdmg}" class="clone-input" data-clone="${i}" data-field="critdmg">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="critdmg">+</button>
                        </div>
                        <div class="clone-field-group">
                            <label>双重射击</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="dual">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].dual}" class="clone-input" data-clone="${i}" data-field="dual">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="dual">+</button>
                        </div>
                    `;
                    cloneModifiersSection.appendChild(block);
                }
                // Attach event listeners for new buttons and inputs
                const modifyAll = document.getElementById('modifyAllClones')?.checked;
                cloneModifiersSection.querySelectorAll('.minus-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.getAttribute('data-clone'));
                        const field = btn.getAttribute('data-field');
                        let newVal = Math.max(0, (parseFloat(cloneModifiers[idx][field]) || 0) - 1);
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = newVal;
                        } else {
                            cloneModifiers[idx][field] = newVal;
                        }
                        renderCloneModifiers(cloneModifiers.length);
                        saveSettings();
                    });
                });
                cloneModifiersSection.querySelectorAll('.plus-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.getAttribute('data-clone'));
                        const field = btn.getAttribute('data-field');
                        let newVal = Math.min(100, (parseFloat(cloneModifiers[idx][field]) || 0) + 1);
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = newVal;
                        } else {
                            cloneModifiers[idx][field] = newVal;
                        }
                        renderCloneModifiers(cloneModifiers.length);
                        saveSettings();
                    });
                });
                cloneModifiersSection.querySelectorAll('.clone-input').forEach(input => {
                    input.addEventListener('input', () => {
                        const idx = parseInt(input.getAttribute('data-clone'));
                        const field = input.getAttribute('data-field');
                        let val = parseFloat(input.value) || 0;
                        if (val < 0) val = 0;
                        if (val > 100) val = 100;
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = val;
                            renderCloneModifiers(cloneModifiers.length);
                        } else {
                            cloneModifiers[idx][field] = val;
                        }
                        saveSettings();
                    });
                });
            }

            // Handle plus/minus for player fields
            document.querySelectorAll('.minus-btn:not([data-clone])').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const min = parseFloat(input.getAttribute('min')) || 0;
                    let val = parseFloat(input.value) || 0;
                    
                    // Define step values for different fields
                    let step = 10; // default step
                    if (['n_clones', 'number_of_drones', 'optimizer_htk', 'optimizer_htd'].includes(targetId)) {
                        step = 1;
                    } else if (['precision', 'hull', 'power', 'evasion', 'available'].includes(targetId)) { // 2025-06-06 Added available points
                        step = 5;
                    } else if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        step = 1;
                    }
                    
                    val = Math.max(min, val - step);
                    // Round to 1 decimal place for percentage fields
                    if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        val = Math.round(val * 10) / 10;
                    }
                    input.value = val;
                    input.dispatchEvent(new Event('input'));
                });
            });
            
            document.querySelectorAll('.plus-btn:not([data-clone])').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const max = parseFloat(input.getAttribute('max')) || Infinity;
                    let val = parseFloat(input.value) || 0;
                    
                    // Define step values for different fields
                    let step = 10; // default step
                    if (['n_clones', 'number_of_drones', 'optimizer_htk', 'optimizer_htd'].includes(targetId)) {
                        step = 1;
                    } else if (['precision', 'hull', 'power', 'evasion', 'available'].includes(targetId)) { // 2025-06-06 Added available points
                        step = 5;
                    } else if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        step = 1;
                    }
                    
                    val = Math.min(max, val + step);
                    // Round to 1 decimal place for percentage fields
                    if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'reputation'].includes(targetId)) {
                        val = Math.round(val * 10) / 10;
                    }
                    input.value = val;
                    input.dispatchEvent(new Event('input'));
                });
            });

            // Simulate button logic
            const simulateBtn = document.getElementById('simulateBtn');
            const battleResultDiv = document.createElement('div');
            battleResultDiv.id = 'battleResult';
            simulateBtn.parentNode.parentNode.parentNode.appendChild(battleResultDiv);
            simulateBtn.addEventListener('click', () => {
                // Gather player fields
                const power = parseInt(form.power.value) || 0;
                const precision = parseInt(form.precision.value) || 0;
                const evasion = parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                // 2025-06-06 Added available points
                const available = parseInt(form.available.value) || 0;
                const weapon_dmg = parseInt(form.weapon_dmg.value) || 0;
                const shield_def = parseInt(form.shield_def.value) || 0;
                const n_clones = parseInt(form.n_clones.value) || 1;
                const weapon_ele1 = form.weapon_ele1.value || null;
                const weapon_ele2 = form.weapon_ele2.value || null;
                const shield_ele1 = form.shield_ele1.value || null;
                const shield_ele2 = form.shield_ele2.value || null;
                const vip_status = form.vip_status.checked;

                // Gather clone modifiers
                const list_modifiers = cloneModifiers.map(mod =>
                    new CloneModifiers(
                        (parseFloat(mod.crit) || 0) / 100,
                        (parseFloat(mod.critdmg) || 0) / 100,
                        (parseFloat(mod.dual) || 0) / 100
                    )
                );

                // Gather mob fields
                const mob_name = form.mob_name.value;
                const mob_level = parseInt(form.mob_level.value) || 1;
                // MobName enum is uppercase keys
                let mob_enum_key = Object.keys(MobName).find(key => MobName[key] === mob_name);
                const mob = new Mob(MobName[mob_enum_key], mob_level);

                // Number of fights
                let n_fights = parseInt(form.n_fights.value) || 1000;
                if (n_fights < 1) n_fights = 1;
                if (n_fights > 1000000) {
                    n_fights = 1000000;
                    form.n_fights.value = 1000000;
                }

                // Create player
                // 2025-06-06 Added available points
                const player = new Player({
                    power, precision, evasion, hull, weapon_dmg, shield_def, n_clones, vip_status,
                    weapon_ele1, weapon_ele2, shield_ele1, shield_ele2, available
                });

                // Create and run battle
                const battle = new Battle({ player, mob, list_modifiers, verbose: false });
                const win_chance = battle.repeat_fights(n_fights);

                // Get income boost and reputation values
                const income_boost = parseFloat(form.income_boost?.value || 0) / 100;
                const reputation = parseFloat(form.reputation?.value || 0) / 100;

                // Print result
                const creditsPerHour = battle.get_revenue('hourly', win_chance, income_boost, reputation);
                const creditsPerDay = battle.get_revenue('daily', win_chance, income_boost, reputation);
                const expPerHour = battle.get_experience('hourly', win_chance, reputation);
                const expPerDay = battle.get_experience('daily', win_chance, reputation);

                battleResultDiv.innerHTML = `<b>胜率：</b> ${(win_chance * 100).toFixed(2)}%<br>` +
                    `<b>货币／小时：</b> ${millify(creditsPerHour)}／小时<br>` +
                    `<b>货币／天:</b> ${millify(creditsPerDay)}／天<br>` +
                    `<b>经验／小时:</b> ${millify(expPerHour)}／小时<br>` +
                    `<b>经验／天:</b> ${millify(expPerDay)}／天`;
            });

            // Optimizer logic
            const optimizerBtn = document.getElementById('optimizerBtn');
            const longOptimizerBtn = document.getElementById('longOptimizerBtn');
            const optimizerResultDiv = document.getElementById('optimizerResult');

            // incremental optimizer
            const incrementalOptimizerBtn = document.getElementById('incrementalOptimizerBtn');


            async function runOptimizer(isLongOptimize = false) {
                const top5Div = document.getElementById('IncrementalOptimizeInfo');
                const optResultDiv = document.getElementById('optimizerResultInfo');

                optResultDiv.style.display = 'flex';
                top5Div.style.display = 'none';

                // Reset progress bar
                const progressBar = document.getElementById('optimizerProgressBar');
                const progressText = document.getElementById('optimizerProgressText');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';

                // Gather player fields
                const power = parseInt(form.power.value) || 0;
                const precision = parseInt(form.precision.value) || 0;
                const evasion = parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                // 2025-06-06 Added available points
                const available = parseInt(form.available.value) || 0;
                const weapon_dmg = parseInt(form.weapon_dmg.value) || 0;
                const shield_def = parseInt(form.shield_def.value) || 0;
                const n_clones = parseInt(form.n_clones.value) || 1;
                const weapon_ele1 = form.weapon_ele1.value || null;
                const weapon_ele2 = form.weapon_ele2.value || null;
                const shield_ele1 = form.shield_ele1.value || null;
                const shield_ele2 = form.shield_ele2.value || null;
                const vip_status = form.vip_status.checked;

                // Gather clone modifiers
                const list_modifiers = cloneModifiers.map(mod =>
                    new CloneModifiers(
                        (parseFloat(mod.crit) || 0) / 100,
                        (parseFloat(mod.critdmg) || 0) / 100,
                        (parseFloat(mod.dual) || 0) / 100
                    )
                );

                // Gather mob fields
                const mob_name = form.mob_name.value;
                const mob_level = parseInt(form.mob_level.value) || 1;
                let mob_enum_key = Object.keys(MobName).find(key => MobName[key] === mob_name);
                const mob = new Mob(MobName[mob_enum_key], mob_level);

                // Create player
                // 2025-06-06 Added available points
                const player = new Player({
                    power, precision, evasion, hull, weapon_dmg, shield_def, n_clones, vip_status,
                    weapon_ele1, weapon_ele2, shield_ele1, shield_ele2, available
                });

                const optimizerFightsInput = document.getElementById('optimizer_n_fights');
                const n_fights = parseInt(optimizerFightsInput.value);
                const reputation = parseFloat(form.reputation?.value || 0) / 100;
                const optimizer = new Optimizer(player, mob, list_modifiers, n_fights, reputation);
                let result;
                
                if (isLongOptimize) {
                    const target = document.querySelector('input[name="optimize_target"]:checked').value;
                    const range_htk = Array.from({length: 7}, (_, i) => i + 4); // range(4,11)
                    const range_htd = Array.from({length: 4}, (_, i) => i + 3); // range(3,7)
                    const totalIterations = range_htk.length * range_htd.length;
                    let currentIteration = 0;

                    let best_build = [0, 0, 0, 0];
                    let best_res = 0;
                    let best_htk = 0;
                    let best_htd = 0;
                    let best_win_chance = 0;

                    for (const htk of range_htk) {
                        for (const htd of range_htd) {
                            const [build, res, win_chance] = optimizer.findBestBuild(htd, htk, target);
                            if (res > best_res) {
                                best_res = res;
                                best_build = build;
                                best_htk = htk;
                                best_htd = htd;
                                best_win_chance = win_chance;
                            }

                            // Update progress
                            currentIteration++;
                            const progress = (currentIteration / totalIterations) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `${Math.round(progress)}%`;
                            
                            // Allow UI to update
                            await new Promise(resolve => setTimeout(resolve, 0));
                        }
                    }

                    result = { bestStats: best_build, winChance: best_win_chance };
                    
                    // Update HTK and HTD fields with the optimal values
                    document.getElementById('optimizer_htk').value = best_htk;
                    document.getElementById('optimizer_htd').value = best_htd;
                    
                    // Save the new values to localStorage
                    const settings = JSON.parse(localStorage.getItem('stellarOdysseySettings') || '{}');
                    settings.optimizer_htk = best_htk;
                    settings.optimizer_htd = best_htd;
                    localStorage.setItem('stellarOdysseySettings', JSON.stringify(settings));
                } else {
                    const target = document.querySelector('input[name="optimize_target"]:checked').value;
                    const htk = parseInt(document.getElementById('optimizer_htk').value);
                    const htd = parseInt(document.getElementById('optimizer_htd').value);
                    
                    // Simple smooth progress over exactly 1 second
                    const startTime = Date.now();
                    const duration = 1000; // 1 second
                    
                    const animateProgress = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration * 100, 100);
                        
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                        
                        if (progress < 100) {
                            requestAnimationFrame(animateProgress);
                        }
                    };
                    
                    requestAnimationFrame(animateProgress);

                    const [bestBuild, bestRes, bestWinChance] = optimizer.findBestBuild(htd, htk, target, false);
                    result = { bestStats: bestBuild, winChance: bestWinChance };
                }

                // Update the results display
                if (result && result.bestStats && result.winChance !== undefined) {
                    const [power, precision, evasion, hull] = result.bestStats;
                    const tmp_player = new Player({
                        power,
                        precision,
                        evasion,
                        hull,
                        weapon_dmg: player.weapon_dmg,
                        shield_def: player.shield_def,
                        n_clones: player.n_clones,
                        vip_status: player.vip_status,
                        weapon_ele1: player.weapon_ele1,
                        weapon_ele2: player.weapon_ele2,
                        shield_ele1: player.shield_ele1,
                        shield_ele2: player.shield_ele2,
                        // 2025-06-06 Added available points
                        available: player.availablePoints
                    });
                    const battle = new Battle({ player: tmp_player, mob: mob, list_modifiers: list_modifiers });
                    
                    // Get income boost and reputation values
                    const income_boost = parseFloat(form.income_boost?.value || 0) / 100;
                    const reputation = parseFloat(form.reputation?.value || 0) / 100;

                    const creditsPerHour = battle.get_revenue('hourly', result.winChance, income_boost, reputation);
                    const creditsPerDay = battle.get_revenue('daily', result.winChance, income_boost, reputation);
                    const expPerHour = battle.get_experience('hourly', result.winChance, reputation);
                    const expPerDay = battle.get_experience('daily', result.winChance, reputation);
                    
                    // Update the stats
                    document.getElementById('opt_power').textContent = power;
                    document.getElementById('opt_precision').textContent = precision;
                    document.getElementById('opt_evasion').textContent = evasion;
                    document.getElementById('opt_hull').textContent = hull;
                  
                    // Update the results
                    document.getElementById('opt_win_chance').textContent = `${(result.winChance * 100).toFixed(2)}%`;
                    document.getElementById('opt_credits_hour').textContent = `${millify(creditsPerHour)}／小时`;
                    document.getElementById('opt_credits_day').textContent = `${millify(creditsPerDay)}／天`;
                    document.getElementById('opt_exp_hour').textContent = `${millify(expPerHour)}／小时`;
                    document.getElementById('opt_exp_day').textContent = `${millify(expPerDay)}／天`;


                    // 2025-06-07 Add fill stat after optimization
                    if (document.getElementById('optimize_fill_after')?.checked) {
                        form.power.value = power;
                        form.precision.value = precision;
                        form.evasion.value = evasion;
                        form.hull.value = hull;
                        // Reset available points after optimization
                        form.available.value = 0;
                    }

                    // Add Import button next to Optimize
                    let importBtn = document.getElementById('importOptimizedBtn');
                    if (!importBtn) {
                        importBtn = document.createElement('button');
                        importBtn.id = 'importOptimizedBtn';
                        importBtn.type = 'button';
                        importBtn.textContent = '填充到玩家数据';
                        optimizerBtn.parentNode.insertBefore(importBtn, optimizerBtn.nextSibling);
                    }
                    importBtn.style.visibility = 'visible';
                    importBtn.onclick = () => {
                        form.power.value = power;
                        form.precision.value = precision;
                        form.evasion.value = evasion;
                        form.hull.value = hull;
                        // 2025-06-06 Added available points
                        form.available.value = 0;
                    };
                } else {
                    // Reset all values to "-"
                    document.getElementById('opt_power').textContent = '-';
                    document.getElementById('opt_precision').textContent = '-';
                    document.getElementById('opt_evasion').textContent = '-';
                    document.getElementById('opt_hull').textContent = '-';
                    document.getElementById('opt_win_chance').textContent = '-';
                    document.getElementById('opt_credits_hour').textContent = '-';
                    document.getElementById('opt_credits_day').textContent = '-';
                    document.getElementById('opt_exp_hour').textContent = '-';
                    document.getElementById('opt_exp_day').textContent = '-';
                    
                    let importBtn = document.getElementById('importOptimizedBtn');
                    if (importBtn) importBtn.style.visibility = 'hidden';
                }
            }
        

            async function runIncrementalOptimizer(isSingleMode = true) {
                console.log(isSingleMode? "SingleMode":"Top5 Mode");
                // 重置进度条
                const progressBar = document.getElementById('optimizerProgressBar');
                const progressText = document.getElementById('optimizerProgressText');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';

                // 读取基础数据（保持原有代码）
                const power = parseInt(form.power.value) || 0;
                const precision = parseInt(form.precision.value) || 0;
                const evasion = parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                const available = parseInt(form.available.value) || 0;
                const weapon_dmg = parseInt(form.weapon_dmg.value) || 0;
                const shield_def = parseInt(form.shield_def.value) || 0;
                const n_clones = parseInt(form.n_clones.value) || 1;
                const weapon_ele1 = form.weapon_ele1.value || null;
                const weapon_ele2 = form.weapon_ele2.value || null;
                const shield_ele1 = form.shield_ele1.value || null;
                const shield_ele2 = form.shield_ele2.value || null;
                const vip_status = form.vip_status.checked;

                const base = {
                    pow: power,
                    pre: precision,
                    eva: evasion,
                    hull: hull
                };

                // 克隆修饰符
                const list_modifiers = cloneModifiers.map(mod =>
                    new CloneModifiers(
                        (parseFloat(mod.crit) || 0) / 100,
                        (parseFloat(mod.critdmg) || 0) / 100,
                        (parseFloat(mod.dual) || 0) / 100
                    )
                );

                // 敌人信息
                const mob_name = form.mob_name.value;
                const mob_level = parseInt(form.mob_level.value) || 1;
                let mob_enum_key = Object.keys(MobName).find(key => MobName[key] === mob_name);
                const mob = new Mob(MobName[mob_enum_key], mob_level);

                // 玩家对象
                const player = new Player({
                    power, precision, evasion, hull, weapon_dmg, shield_def, n_clones, vip_status,
                    weapon_ele1, weapon_ele2, shield_ele1, shield_ele2, available
                });

                // 战斗次数和声望
                const optimizerFightsInput = document.getElementById('optimizer_n_fights');
                const n_fights = parseInt(optimizerFightsInput.value);
                const reputation = parseFloat(form.reputation?.value || 0) / 100;

                // 优化器实例
                const optimizer = new Optimizer(player, mob, list_modifiers, n_fights, reputation);

                // 目标类型
                const target = document.querySelector('input[name="optimize_target"]:checked').value;

                const updateProgress = (current, total) => {
                    const progress = (current / total) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}%`;
                    return new Promise(resolve => setTimeout(resolve, 0));
                };

                if (!isSingleMode) {
                    // TOP5模式，多次获取
                    const topResults = new Map(); // 用于去重构型
                    let attempts = 0;

                    while (topResults.size < 10 && attempts < 50) { // 最多尝试 50 次，防止死循环
                        const result = await optimizer.findBestIncremental(target, true, updateProgress);

                        const key = result.build.join(',');
                        if (!topResults.has(key)) {
                            topResults.set(key, result);
                            document.getElementById('opt_result').textContent = `正在计算[${topResults.size}/10]...`;
                        }

                        attempts++;
                    }

                    const bestList = Array.from(topResults.values())
                        .sort((a, b) => b.win_chance - a.win_chance)
                        .slice(0, 5);

                    return {
                        bestList,
                        baseStats: base
                    };
                } else {
                    // 单次模式，直接返回单条结果
                    const result = await optimizer.findBestIncremental(target, true, updateProgress);

                    return {
                        bestStats: result.build,
                        baseStats: base,
                        winChance: result.win_chance,
                        resource: result.resource
                    };
                }
            }


        function displayOptimizerResult(result, isSingleMode = true) {
            const optResultContainer = document.getElementById('opt_result');

            if (!isSingleMode) {
                // TOP5MODE 显示表格
                optResultContainer.innerHTML = '';

                const table = document.createElement('table');
                table.style.fontFamily = '"Rajdhani", Tahoma, Arial, sans-serif';
                table.style.margin = '0 auto';
                table.style.textAlign = 'center';
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['#', '力量', '精准', '闪避', '船体', '▲力量', '▲精准', '▲闪避', '▲船体', '胜率', ''].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    th.style.border = '1px solid #ccc';
                    th.style.padding = '4px';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                const baseStats = ['pow', 'pre', 'eva', 'hull'].map(k => result.baseStats[k]);

                const applyStats = (idx) => {
                    const [power, precision, evasion, hull] = result.bestList[idx].build;
                    form.power.value = power;
                    form.precision.value = precision;
                    form.evasion.value = evasion;
                    form.hull.value = hull;
                    form.available.value = 0;
                }

                result.bestList.forEach((r, idx) => {
                    const tr = document.createElement('tr');
                    const tdRank = document.createElement('td');
                    tdRank.textContent = (idx + 1).toString();
                    tdRank.style.border = '1px solid #ccc';
                    tdRank.style.padding = '4px';
                    tr.appendChild(tdRank);

                    r.build.forEach(val => {
                        const td = document.createElement('td');
                        td.textContent = val;
                        td.style.border = '1px solid #ccc';
                        td.style.padding = '4px';
                        tr.appendChild(td);
                    });

                    r.build.forEach((val, idx) => {
                        const td = document.createElement('td');
                        const increasement = val - baseStats[idx];
                        td.innerHTML = increasement > 0 ? `[<font color="Lime">+${increasement}</font>]` : '(0)';
                        td.style.border = '1px solid #ccc';
                        td.style.padding = '4px';
                        tr.appendChild(td);
                    });                

                    const tdWinChance = document.createElement('td');
                    tdWinChance.textContent = (r.win_chance * 100).toFixed(2) + '%';
                    tdWinChance.style.border = '1px solid #ccc';
                    tdWinChance.style.padding = '4px';
                    tr.appendChild(tdWinChance);

                    const tdApply = document.createElement('td');
                    const btApply = document.createElement('button');
                    btApply.type = 'button';
                    btApply.style.margin = '0';
                    btApply.style.padding = '0.3em 0.3em';
                    btApply.textContent = '应用';
                    btApply.id = `apply_top${idx+1}`;
                    btApply.addEventListener('click', () => {
                        applyStats(idx);
                    });
                    tdApply.appendChild(btApply);
                    tdApply.style.border = '1px solid #ccc';
                    tdApply.style.padding = '4px';
                    tr.appendChild(tdApply);

                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                optResultContainer.appendChild(table);

            } else {
                const base = result.baseStats;
                // SINGLEMODE 显示单条结果
                const IncrementalOptimizeResult = {
                    power: result.bestStats[0],
                    precision: result.bestStats[1],
                    evasion: result.bestStats[2],
                    hull: result.bestStats[3]
                };

                const IncrementalOptimizeIncresement = {
                    power: IncrementalOptimizeResult.power - base.pow,
                    precision: IncrementalOptimizeResult.precision - base.pre,
                    evasion: IncrementalOptimizeResult.evasion - base.eva,
                    hull: IncrementalOptimizeResult.hull - base.hull
                };

                document.getElementById('opt_power').innerHTML = `${IncrementalOptimizeResult.power} (<font color=${IncrementalOptimizeIncresement.power > 0 ? "'Lime'" : "'white'"}>${IncrementalOptimizeIncresement.power > 0 ? '+' : ''}${IncrementalOptimizeIncresement.power}</font>)`;
                document.getElementById('opt_precision').innerHTML = `${IncrementalOptimizeResult.precision} (<font color=${IncrementalOptimizeIncresement.precision > 0 ? "'Lime'" : "'white'"}>${IncrementalOptimizeIncresement.precision > 0 ? '+' : ''}${IncrementalOptimizeIncresement.precision}</font>)`;
                document.getElementById('opt_evasion').innerHTML = `${IncrementalOptimizeResult.evasion} (<font color=${IncrementalOptimizeIncresement.evasion > 0 ? "'Lime'" : "'white'"}>${IncrementalOptimizeIncresement.evasion > 0 ? '+' : ''}${IncrementalOptimizeIncresement.evasion}</font>)`;
                document.getElementById('opt_hull').innerHTML = `${IncrementalOptimizeResult.hull} (<font color=${IncrementalOptimizeIncresement.hull > 0 ? "'Lime'" : "'white'"}>${IncrementalOptimizeIncresement.hull > 0 ? '+' : ''}${IncrementalOptimizeIncresement.hull}</font>)`;
                
                document.getElementById('opt_win_chance').textContent = `${(result.winChance * 100).toFixed(2)}%`;
                document.getElementById('opt_credits_hour').textContent = `${millify(result.resource.credits_hourly)}／小时`;
                document.getElementById('opt_credits_day').textContent = `${millify(result.resource.credits_daily)}／天`;
                document.getElementById('opt_exp_hour').textContent = `${millify(result.resource.exp_hourly)}／小时`;
                document.getElementById('opt_exp_day').textContent = `${millify(result.resource.exp_daily)}／天`;

            }
        }


            optimizerBtn.addEventListener('click', () => runOptimizer(false));
            longOptimizerBtn.addEventListener('click', () => runOptimizer(true));

            // incrementalOptimizerBtn 的事件监听，控制显示切换，并调用显示函数
            incrementalOptimizerBtn.addEventListener('click', async () => {
                try {
                    // 读取是否选中TOP5模式
                    const isSingleMode = !document.getElementById('incrementalTop5Mode').checked;

                    // 切换显示样式
                    const top5Div = document.getElementById('IncrementalOptimizeInfo');
                    const optResultDiv = document.getElementById('optimizerResultInfo');
                    
                    document.getElementById('opt_result').textContent = '正在计算...';

                    if (isSingleMode) {
                        top5Div.style.display = 'none';
                        optResultDiv.style.display = 'flex';
                    } else {
                        top5Div.style.display = 'flex';
                        optResultDiv.style.display = 'none';
                    }

                    // 运行优化器，传入模式
                    const result = await runIncrementalOptimizer(isSingleMode);

                    console.log(result);

                    // 显示结果，传入模式
                    displayOptimizerResult(result, isSingleMode);

                } catch (error) {
                    console.error('优化过程中出错:', error);
                    alert('优化失败: ' + error.message);
                }
            });

            // Add event listeners to save settings when values change
            form.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', saveSettings);
                if (element.type === 'number' || element.type === 'text') {
                    element.addEventListener('input', saveSettings);
                }
            });

            // For number inputs, also save on input event for immediate feedback
            form.querySelectorAll('input[type="number"]').forEach(element => {
                element.addEventListener('input', saveSettings);
            });

            // Add event listeners for all minus/plus buttons
            document.querySelectorAll('.minus-btn, .plus-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    if (targetId) {
                        const input = document.getElementById(targetId);
                        if (input) {
                            input.dispatchEvent(new Event('input'));
                            saveSettings();
                        }
                    }
                });
            });

            // Modify the clone modifiers event listeners to save settings
            function addCloneModifierListeners() {
                cloneModifiersSection.querySelectorAll('.minus-btn, .plus-btn, .clone-input').forEach(element => {
                    element.addEventListener('change', saveSettings);
                    if (element.classList.contains('clone-input')) {
                        element.addEventListener('input', saveSettings);
                    }
                });
            }

            // Update the renderCloneModifiers function to add listeners
            const originalRenderCloneModifiers = renderCloneModifiers;
            renderCloneModifiers = function(n) {
                originalRenderCloneModifiers(n);
                addCloneModifierListeners();
            };
            
            
            // Add API import functionality
            const importBtn = document.getElementById('importBtn');
            const apiKeyInput = document.getElementById('api_key');
            
            async function fetchUserData(apiKey) {
                try {
                    const response = await axios({
                        method: 'get',
                        url: 'https://api.stellarodyssey.app/api/public/user',
                        headers: {
                            'Accept': 'application/json',
                            'sodyssey-api-key': apiKey
                        },
                        timeout: 5000
                    });
                    return response.data;
                } catch (error) {
                    let errorMessage = 'Failed to fetch user data. ';
                    
                    if (error.response) {
                        if (error.response.status === 401) {
                            errorMessage += 'Invalid API key.';
                        } else if (error.response.status === 404) {
                            errorMessage += 'User not found.';
                        } else {
                            errorMessage += `Server responded with status ${error.response.status}.`;
                        }
                    } else if (error.code === 'ECONNABORTED') {
                        errorMessage += 'Request timed out.';
                    } else if (error.code === 'ERR_NETWORK') {
                        if (error.message.includes('CORS')) {
                            errorMessage += 'CORS error: The API server is not configured to allow requests from this domain. Please contact the API administrators.';
                        } else {
                            errorMessage += 'Network error. Please check your internet connection.';
                        }
                    } else {
                        errorMessage += error.message;
                    }
                    
                    throw new Error(errorMessage);
                }
            }

            function updateFormWithUserData(userData) {
                const data = userData.data;
                
                // Update form fields with API data
                if (data.stats) {
                    form.power.value = data.stats.power || 0;
                    form.precision.value = data.stats.precision || 0;
                    form.evasion.value = data.stats.evasion || 0;
                    form.hull.value = data.stats.hull || 0;
                    // 2025-06-06 - Added available points
                    form.available.value = data.stats.available || 0;
                }

                // Update ship data
                if (data.ship) {
                    if (data.ship.weapon) {
                        form.weapon_dmg.value = data.ship.weapon.value || 0;
                        if (data.ship.weapon.bonuses && data.ship.weapon.bonuses.length > 0) {
                            form.weapon_ele1.value = data.ship.weapon.bonuses[0].charAt(0).toUpperCase() + data.ship.weapon.bonuses[0].slice(1);
                            if (data.ship.weapon.bonuses.length > 1) {
                                form.weapon_ele2.value = data.ship.weapon.bonuses[1].charAt(0).toUpperCase() + data.ship.weapon.bonuses[1].slice(1);
                            } else {
                                form.weapon_ele2.value = '';
                            }
                        } else {
                            form.weapon_ele1.value = '';
                            form.weapon_ele2.value = '';
                        }
                    }

                    if (data.ship.shield) {
                        form.shield_def.value = data.ship.shield.value || 0;
                        if (data.ship.shield.bonuses && data.ship.shield.bonuses.length > 0) {
                            form.shield_ele1.value = data.ship.shield.bonuses[0].charAt(0).toUpperCase() + data.ship.shield.bonuses[0].slice(1);
                            if (data.ship.shield.bonuses.length > 1) {
                                form.shield_ele2.value = data.ship.shield.bonuses[1].charAt(0).toUpperCase() + data.ship.shield.bonuses[1].slice(1);
                            } else {
                                form.shield_ele2.value = '';
                            }
                        } else {
                            form.shield_ele1.value = '';
                            form.shield_ele2.value = '';
                        }
                    }
                }

                // Update VIP status
                form.vip_status.checked = data.premium || false;

                // Update number of clones and clone modifiers
                if (data.clones && data.clones.length > 0) {
                    form.n_clones.value = data.clones.length;
                    cloneModifiers = data.clones.map(clone => ({
                        crit: clone.critical_chance || 0,
                        critdmg: clone.critical_damage || 0,
                        dual: clone.dual_shot || 0
                    }));
                }

                // Update current mob and level
                if (data.actions) {
                    if (data.actions.currentNpc) {
                        form.mob_name.value = data.actions.currentNpc.charAt(0).toUpperCase() + data.actions.currentNpc.slice(1);
                    }
                    if (data.actions.currentNpcLevel) {
                        form.mob_level.value = data.actions.currentNpcLevel;
                    }
                }

                // Handle spacestation incomeboost
                if (data.spacestation && data.spacestation.incomeboost) {
                    form.income_boost.value = data.spacestation.incomeboost * 2.0;
                } else {
                    form.income_boost.value = 0;
                }

                // Handle reputation
                if (data.reputation !== null && data.reputation !== undefined) {
                    form.reputation.value = (data.reputation * 0.2).toFixed(1);
                } else {
                    form.reputation.value = 0;
                }

                // Render clone modifiers with the new data
                renderCloneModifiers(parseInt(form.n_clones.value) || 1);
                
                const nClonesInput = document.getElementById('n_clones');
                nClonesInput.dispatchEvent(new Event('input'));
                
                saveSettings();
            }

            importBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('请输入你的 API key');
                    return;
                }

                try {
                    importBtn.disabled = true;
                    importBtn.textContent = '导入中...';

                    const userData = await fetchUserData(apiKey);
                    updateFormWithUserData(userData);
                    
                    importBtn.disabled = false;
                    importBtn.textContent = '导入';
                } catch (error) {
                    alert(error.message);
                    
                    importBtn.disabled = false;
                    importBtn.textContent = '导入';
                }
            });
   
        });
    </script>
</head>
<body>
    <div style="font-size: 1.7em; font-weight: 600; margin-bottom: 1.2em; letter-spacing: 0.01em;">恒星奥德赛模拟优化器</div>
    
    <!-- Tab content sections -->
    <div id="battling-tab" class="tab-content active">
        <form id="playerForm" class="form-section" autocomplete="off" style="display: flex; flex-direction: row; gap: 2em;">
            <div style="flex: 3;">
                <div class="player-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                    <div class="block-label">玩家</div>
                    <div class="form-row"><!-- // 2025-06-06 Added available points -->
                        <div class="form-group">
                            <label for="available">剩余点数：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="available">-</button>
                                <input type="number" id="available" name="available" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="available">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="power">威力（力量）：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="power">-</button>
                                <input type="number" id="power" name="power" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="power">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="precision">精准：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="precision">-</button>
                                <input type="number" id="precision" name="precision" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="precision">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="evasion">闪避：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="evasion">-</button>
                                <input type="number" id="evasion" name="evasion" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="evasion">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="hull">船体：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="hull">-</button>
                                <input type="number" id="hull" name="hull" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="hull">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="weapon_dmg">武器伤害：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="weapon_dmg">-</button>
                                <input type="number" id="weapon_dmg" name="weapon_dmg" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="weapon_dmg">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="shield_def">护盾防御：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="shield_def">-</button>
                                <input type="number" id="shield_def" name="shield_def" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="shield_def">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="weapon_ele1">武器改造1：</label>
                            <select id="weapon_ele1" name="weapon_ele1">
                                <option value="">无</option>
                                <option value="Chemical">化学</option>
                                <option value="Electromagnetic">电磁</option>
                                <option value="Energy">能量</option>
                                <option value="Explosive">爆炸</option>
                                <option value="Incendiary">燃烧</option>
                                <option value="Kinetic">动能</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="weapon_ele2">武器改造2：</label>
                            <select id="weapon_ele2" name="weapon_ele2">
                                <option value="">无</option>
                                <option value="Chemical">化学</option>
                                <option value="Electromagnetic">电磁</option>
                                <option value="Energy">能量</option>
                                <option value="Explosive">爆炸</option>
                                <option value="Incendiary">燃烧</option>
                                <option value="Kinetic">动能</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shield_ele1">护盾改造1：</label>
                            <select id="shield_ele1" name="shield_ele1">
                                <option value="">无</option>
                                <option value="Chemical">化学</option>
                                <option value="Electromagnetic">电磁</option>
                                <option value="Energy">能量</option>
                                <option value="Explosive">爆炸</option>
                                <option value="Incendiary">燃烧</option>
                                <option value="Kinetic">动能</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="shield_ele2">护盾改造2：</label>
                            <select id="shield_ele2" name="shield_ele2">
                                <option value="">无</option>
                                <option value="Chemical">化学</option>
                                <option value="Electromagnetic">电磁</option>
                                <option value="Energy">能量</option>
                                <option value="Explosive">爆炸</option>
                                <option value="Incendiary">燃烧</option>
                                <option value="Kinetic">动能</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="n_clones">克隆数量：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="n_clones">-</button>
                                <input type="number" id="n_clones" name="n_clones" value="1" min="1" max="10">
                                <button type="button" class="plus-btn" data-target="n_clones">+</button>
                            </div>
                        </div>
                        <div class="form-group" style="align-items: flex-start; justify-content: flex-end;">
                            <label for="vip_status" style="margin-bottom: 0;">
                                <input type="checkbox" id="vip_status" name="vip_status">
                                VIP 属性
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mob-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                    <div class="block-label">敌人</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mob_name">敌人名称：</label>
                            <select id="mob_name" name="mob_name">
                                <option value="Brutes">蛮兵</option>
                                <option value="Dusters">尘暴兵</option>
                                <option value="Machiners">机械师</option>
                                <option value="Toxoids">毒蚀体</option>
                                <option value="Scorchers">灼烧者</option>
                                <option value="Glacials">冰川族</option>
                                <option value="Spectres">幽灵</option>
                                <option value="Miners">矿工</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mob_level">等级：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="mob_level">-</button>
                                <input type="number" id="mob_level" name="mob_level" value="1" min="1">
                                <button type="button" class="plus-btn" data-target="mob_level">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mob-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                    <div class="block-label">舰队BUFF</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="income_boost">空间站：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="income_boost">-</button>
                                <input type="number" id="income_boost" name="income_boost" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <span style="margin: 0 0.2em;">%</span>
                                <button type="button" class="plus-btn" data-target="income_boost">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reputation">声望：</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="reputation">-</button>
                                <input type="number" id="reputation" name="reputation" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <span style="margin: 0 0.2em;">%</span>
                                <button type="button" class="plus-btn" data-target="reputation">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; flex-direction: row; align-items: flex-start;">
                <div style="position: relative; width: fit-content;">
                    <div style="position: absolute; left: 180px; top: -2.1em; z-index: 2;">
                        <label style="font-size: 1.08em; display: flex; align-items: center; color: #e6eaf3; background: #23283a; padding: 0.1em 0.7em 0.1em 0.5em; border-radius: 5px; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);">
                            <input type="checkbox" id="modifyAllClones" style="margin-right: 0.5em;"> 同时修改所有克隆
                        </label>
                    </div>
                    <div id="cloneModifiersSection" class="clone-modifiers-section"></div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-start; margin-left: 7.5em;">
                    <div class="api-block" style="margin-top: 0; margin-left: 5px; min-height: 110px; max-height: 180px; width: 600px; min-width: 450px; max-width: 600px; background: #23283a; border-radius: 6px; border: 1px solid #2c3242; padding: 0.7em 1.2em 0.5em 1.2em; box-sizing: border-box;">
                        <div class="block-label">导入数据
                            <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Import your player, mob and clone stats using your API key. This will automatically fill in all your current stats. Your API key is located in Settings">ⓘ</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="api_key">API Key（游戏设置API Key里Generate后粘贴）：</label>
                            </div>
                            <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: 110px;">
                                <button id="importBtn" type="button">导入</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" id="api_key" name="api_key" style="width: 100%; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.2em;">
                            </div>
                        </div>
                    </div>
                    <div class="battle-block" style="margin-top: 1.0em; margin-left: 5px; min-height: 230px; max-height: 250px;width: 500px; min-width: 350px; max-width: 500px">
                        <div class="block-label">战斗模拟器
                            <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Run a battle simulation with the current configuration. The simulation will execute the specified number of battles (up to 1,000,000) to calculate win probability and resource gains.">ⓘ</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="n_fights">模拟战斗次数：</label>
                                <input type="number" id="n_fights" name="n_fights" value="10000" min="1" max="1000000" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            </div>
                            <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: -30px;">
                                <button id="simulateBtn" type="button">开始模拟</button>
                            </div>
                        </div>
                    </div>
                    <div class="optimizer-block" style="margin-top: 1.5em; margin-left: 5px; width: 600px; min-width: 600px; max-width: 600px; min-height: 210px;">
                        <div class="block-label">优化模拟
                            <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Find the optimal stat distribution for your current configuration. The optimizer will test various stat combinations using the specified number of simulations (up to 1,000,000). Higher values provide more accurate results but significantly increase computation time and may temporarily freeze the interface. Consider starting with a lower number and increasing it if needed.">ⓘ</span>
                        </div>
                        <div style="display: flex;align-items: baseline;margin-bottom: 1em;justify-content: flex-start;flex-direction: row;">
                            <span style="margin-right: 10px;">针对性优化:</span>
                            <label style="margin-right: 15px; display: flex; align-items: center;">
                                <input type="radio" name="optimize_target" value="credits" checked style="margin-right: 5px;"> 货币
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="optimize_target" value="exp" style="margin-right: 5px;"> 经验
                            </label>
                            <label style="display: flex; align-items:flex-start;justify-content:center; margin-left: 40px;">
                                <input type="checkbox" id="optimize_fill_after" name="optimize_fill_after" checked style="margin-right: 5px;"> 优化后填充属性
                            </label>
                        </div>
                        <div class="form-row" style="margin-bottom: 1em;">
                            <div class="form-group">
                                <label for="optimizer_htk">击杀所需命中数（HTK）:
                                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Hits to kill: The number of hits needed to defeat the mob">ⓘ</span>
                                </label>
                                <div class="input-group">
                                    <button type="button" class="minus-btn" data-target="optimizer_htk">-</button>
                                    <input type="number" id="optimizer_htk" name="optimizer_htk" value="8" min="1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                    <button type="button" class="plus-btn" data-target="optimizer_htk">+</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="optimizer_htd">死亡所需被击数（HTD）:
                                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Hits to die: The number of hits the mob needs to defeat your clones">ⓘ</span>
                                </label>
                                <div class="input-group">
                                    <button type="button" class="minus-btn" data-target="optimizer_htd">-</button>
                                    <input type="number" id="optimizer_htd" name="optimizer_htd" value="4" min="1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                    <button type="button" class="plus-btn" data-target="optimizer_htd">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row"  style="display: flex; gap: 1em; margin-bottom: 1em; align-items: center;">
                            <div class="form-group">
                                <label for="optimizer_n_fights">模拟战斗次数：</label>
                                <input type="number" id="optimizer_n_fights" name="optimizer_n_fights" value="5000" min="1" max="1000000" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            </div>
                            <div class="form-group" style="display: flex; flex-direction: row; flex-wrap: wrap; align-items:baseline; margin-left: -250px;">
                                <button id="optimizerBtn" type="button" style="margin-right: 10px;">简单计算优化</button>
                                <button id="longOptimizerBtn" type="button" style="margin-right: 10px;" title="Optimize by searching through multiple values of HTK and HTD. It is not advised to use more than 5000 fights">复杂计算优化</button>
                                <button id="importOptimizedBtn" type="button" style="visibility: hidden;">填充到玩家数据</button>
                                <br style="flex-basis: 100%; height: 0;">
                                <button id="incrementalOptimizerBtn" type="button" style="margin-right: 10px;">增量（加点）建议</button>
                                <input type="checkbox" id="incrementalTop5Mode" name="incrementalTop5Mode" style="margin-right: 5px;"></input>
                                <label for="incrementalTop5Mode" style="margin-right: 10px;color: #4fa3ff;" title="在尽可能保证满足10条最优解的情况下进行计算，但是总共计算不会超过50次。">最优5模式 ⓘ</label>
                            </div>
                        </div>
                        <div id="optimizerProgress" style="height: 50px; margin: 1em 0;">
                            <div style="width: 100%; background: #36405a; border-radius: 4px; height: 20px; overflow: hidden;">
                                <div id="optimizerProgressBar" style="width: 0%; height: 100%; background: #4fa3ff; transition: width 0.3s ease;"></div>
                            </div>
                            <div id="optimizerProgressText" style="text-align: center; margin-top: 0.5em; font-size: 0.9em; color: #b0b6c6;">0%</div>
                        </div>
                        <div id="optimizerResult" style="display: flex; flex-direction: row; gap: 2em; margin-top: 1em;">
                            <div id="optimizerResultInfo" class="form-row">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.2em 1.2em; width: 180px; font-size: 1em;">
                                    <div><b>力量</b><br><span id="opt_power">-</span></div>
                                    <div><b>精准</b><br><span id="opt_precision">-</span></div>
                                    <div><b>闪避</b><br><span id="opt_evasion">-</span></div>
                                    <div><b>船体</b><br><span id="opt_hull">-</span></div>
                                </div>
                                <div style="font-size: 0.98em;">
                                    <div><b>胜率：</b> <span id="opt_win_chance">-</span></div>
                                    <div><b>货币／小时：</b> <span id="opt_credits_hour">-</span></div>
                                    <div><b>货币／天：</b> <span id="opt_credits_day">-</span></div>
                                    <div><b>经验／小时：</b> <span id="opt_exp_hour">-</span></div>
                                    <div><b>经验／天：</b> <span id="opt_exp_day">-</span></div>
                                </div>
                            </div>
                            <div id="IncrementalOptimizeInfo" class="form-row" style="display:none; flex-direction: column;align-items: center;width: 100%;font-size: 1.1em;align-content: center;justify-content: center; ">
                                <div id="opt_result">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="gathering-tab" class="tab-content">
        <div class="form-section" style="display: flex; flex-direction: row; gap: 2em;">
            <div class="optimizer-block" style="margin-top: 1.0em; margin-left: 5px; width: 500px; min-width: 500px; max-width: 500px; min-height: 210px; position: relative;">
                <div style="position: absolute; top: 0.5em; right: 1em; text-align: left; font-size: 0.75em; color: #b0b6c6; line-height: 1.2;">
                    如需更精确的资源计算<br>
                    请访问: <a href="https://docs.google.com/spreadsheets/d/1DCpkdBsHL_dqa_Fv13k3M1iKVuBCa4vXbfTjToQ64G8/edit?gid=1892479921#gid=1892479921" target="_blank" style="color: #4fa3ff; text-decoration: none;">Google表单</a>
                </div>
                <div class="block-label">资源计算器
                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="根据当前设置计算资源收集率和达到特定目标所需的时间。
•‘“资源”和“稀有资源”指的是你当前在当前星球上在每个行动中收集的物品。
•‘“额外闪避”和“额外稀有资源掉落”仅取决于激光和探测器的改造
•‘“平均机动性”是指所有无人机的平均机动性能。">ⓘ</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="resources_per_action">资源／行动：</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="resources_per_action">-</button>
                            <input type="number" id="resources_per_action" name="resources_per_action" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <button type="button" class="plus-btn" data-target="resources_per_action">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="rare_resources_per_action">稀有资源／行动：</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="rare_resources_per_action">-</button>
                            <input type="number" id="rare_resources_per_action" name="rare_resources_per_action" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <button type="button" class="plus-btn" data-target="rare_resources_per_action">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="number_of_drones">无人机数量：</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="number_of_drones">-</button>
                            <input type="number" id="number_of_drones" name="number_of_drones" value="1" min="1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <button type="button" class="plus-btn" data-target="number_of_drones">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dodge_percentage">额外闪避（装备）：</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="dodge_percentage">-</button>
                            <input type="number" id="dodge_percentage" name="dodge_percentage" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="dodge_percentage">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="rare_drop_increase">额外稀有资源掉落（装备）：</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="rare_drop_increase">-</button>
                            <input type="number" id="rare_drop_increase" name="rare_drop_increase" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="rare_drop_increase">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="maneuverability">平均机动性（无人机升级）：</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="maneuverability">-</button>
                            <input type="number" id="maneuverability" name="maneuverability" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="maneuverability">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: 0;">
                        <button id="calculateResourcesBtn" type="button">计算</button>
                    </div>
                </div>
                <div id="resourcesResult" style="display: flex; flex-direction: row; gap: 2em; margin-top: 1em;">
                    <div style="font-size: 0.98em;">
                        <div><b>资源／小时：</b> <span id="resources_per_hour">-</span></div>
                        <div><b>稀有资源／小时：</b> <span id="rare_resources_per_hour">-</span></div>
                        <div><b>收集32M资源所需时间：</b> <span id="hours_to_32m">-</span></div>
                        <div><b>收集800k稀有资源所需时间：</b> <span id="days_to_800k">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="universe-map-tab" class="tab-content">
        <div style="display: flex; flex-direction: row; padding: 2em; gap: 2em; height: 720px;">
            <div style="display: flex; flex-direction: column; gap: 1em; min-width: 400px; max-width: 400px; margin-top: 37vh; transform: translateY(-50%);">
                <div style="background: #23283a; border-radius: 6px; border: 1px solid #2c3242; padding: 1.2em; box-sizing: border-box;">
                    <div style="font-size: 1.22em; font-weight: 700; margin-bottom: 1em; color: #f3f6fa; letter-spacing: 0.01em;">已发现星系</div>
                    <div style="display: flex; flex-direction: column; gap: 1em;">
                        <div>
                            <label for="systems_api_key" style="display: block; margin-bottom: 0.5em; color: #e6eaf3;">API Key:</label>
                            <input type="text" id="systems_api_key" style="width: 100%; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.5em; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        <div style="color: #e6eaf3; font-size: 0.9em; margin-bottom: 0.0em;" id="systemsCount">目前尚无公开发现的星系</div>
                        <div style="color: #e6eaf3; font-size: 0.9em; margin-bottom: 1.0em;" id="totalDistance">你当前已旅行0光年</div>
                        <div style="display: flex; flex-direction: column; gap: 0.5em;">
                            <label style="display: flex; align-items: center; gap: 0.5em; color: #e6eaf3; cursor: pointer;">
                                <input type="checkbox" id="show_public_systems" style="margin: 0;">
                                显示公开星系（关闭时仅显示初始/你发现的）
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5em; color: #e6eaf3; cursor: pointer;">
                                <input type="checkbox" id="show_current_position" style="margin: 0;">
                                显示当前位置（定位）
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5em; color: #e6eaf3; cursor: pointer;">
                                <input type="checkbox" id="show_player_journey" style="margin: 0;">
                                显示玩家旅行路径
                            </label>
                        </div>
                        <button id="loadSystemsBtn" type="button" style="background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.5em 1em; border-radius: 4px; cursor: pointer; width: 100%;">Load Systems</button>
                    </div>
                </div>
            </div>
            <div style="position: relative; width: 720px; height: 720px; background: #181c24;">
                <canvas id="universeMap" style="width: 100%; height: 100%;"></canvas>
            </div>
        </div>
    </div>

    <div id="probabilities-tab" class="tab-content">
        <div class="form-section" style="display: flex; flex-direction: row; gap: 2em;">
            <div class="optimizer-block" style="margin-top: 1.0em; margin-left: 5px; width: 500px; min-width: 500px; max-width: 500px; min-height: 210px; max-height: 600px;">
                <div class="block-label">
                    星系概率计算器
                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Calculate the probability of observing a system with specific characteristics. This tool uses complex probability calculations involving multiple parameters (nodes, categories, qualities) and their interactions. Due to the mathematical complexity of these calculations, some results may require further refinement. The current implementation is being continuously improved for accuracy.">ⓘ</span>
                    <span style="color: #ff4f4f; margin-left: 5px; font-size: 0.8em; font-weight: normal;">beta</span>
                </div>
                <div class="form-row" style="margin-bottom: 1em;">
                    <div class="form-group">
                        <label for="inhabited_system" style="color: #e6eaf3;">星系状态：</label>
                        <select id="inhabited_system" name="inhabited_system" style="width: 12em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.2em; border-radius: 4px;">
                            <option value="any">任意</option>
                            <option value="inhabited">星系有人居住</option>
                            <option value="uninhabited">星系无人居住</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_nodes">节点数量：</label>
                        <div class="input-group">
                            <select id="n_nodes_type" name="n_nodes_type" style="width: 6em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; margin-right: 0.5em;">
                                <option value="exactly">精确</option>
                                <option value="at least">至少</option>
                                <option value="any">任意</option>
                            </select>
                            <input type="number" id="n_nodes" name="n_nodes" value="1" min="1" max="5" style="width: 3.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_gatherable">采集节点数量：</label>
                        <div class="input-group">
                            <select id="n_gatherable_type" name="n_gatherable_type" style="width: 6em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; margin-right: 0.5em;">
                                <option value="exactly">精确</option>
                                <option value="at least">至少</option>
                                <option value="any">任意</option>
                            </select>
                            <input type="number" id="n_gatherable" name="n_gatherable" value="1" min="0" max="5" style="width: 3.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_categories">不同类别数量：</label>
                        <div class="input-group">
                            <select id="n_categories_type" name="n_categories_type" style="width: 6em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; margin-right: 0.5em;">
                                <option value="exactly">精确</option>
                                <option value="at least">至少</option>
                                <option value="any">任意</option>
                            </select>
                            <input type="number" id="n_categories" name="n_categories" value="1" min="1" max="4" style="width: 3.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                    </div>
                </div>
                <div id="quality-selections" style="margin-top: 0.5em; display: flex; flex-direction: column; gap: 0.3em;">
                    <div class="form-row" style="display: flex; align-items: center; gap: 0.5em; margin-bottom: 0;">
                        <label style="color: #e6eaf3; min-width: 180px;">采集节点 1 品质:</label>
                        <select style="width: 8em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.2em; border-radius: 4px;">
                            <option value="any">任意</option>
                            <option value="1-30">1-30</option>
                            <option value="31-70">31-70</option>
                            <option value="71-90">71-90</option>
                            <option value="91-100">91-100</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1em; display: flex; flex-direction: column; align-items: flex-start; gap: 0.5em;">
                    <button id="calculateProbabilityBtn" type="button" style="background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.5em 1em; border-radius: 4px; cursor: pointer;">计算概率</button>
                    <div id="probabilityResult" style="color: #e6eaf3; font-size: 1.1em;">
                        <div>概率：<span id="probability_value"></span></div>
                        <div>预计宇宙中的星系数量: <span id="estimated_systems"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab bar -->
    <div class="tab-container">
        <div class="tab active" data-tab="battling-tab">战斗</div>
        <div class="tab" data-tab="gathering-tab">采集</div>
        <div class="tab" data-tab="universe-map-tab">星图</div>
        <div class="tab" data-tab="probabilities-tab">概率</div>
    </div>

    <div id="playerResult"></div>
    <footer>
        <span>Proudly made by anfneub <a href="https://anfneub.github.io/StellarOdysseySim/" target="_blank">(Original Simulator Link Here)</a></span>
        <span style="margin-left: 2.5em;" >中文化: <font color="#e02020">SakakiChizuru</font></span>
        <span style="margin-left: 2.5em;" id="lastUpdated"></span>
        <span style="margin-left: 2.5em;">Space Odyssey Version 1.1.6 2025-05-30</span>
        <span style="margin-left: 2.5em; cursor: pointer; color: #4fa3ff; text-decoration: underline;" id="changelogLink">Changelog</span>
    </footer>

    <!-- Add tab switching script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab');
            
            // Function to switch tabs
            function switchTab(tab) {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Save active tab to localStorage
                localStorage.setItem('activeTab', tabId);
            }

            // Add click handlers to all tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab));
            });

            // Restore active tab from localStorage
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab) {
                const tabToActivate = document.querySelector(`.tab[data-tab="${savedTab}"]`);
                if (tabToActivate) {
                    switchTab(tabToActivate);
                }
            }
        });
    </script>
    <script>
        // Set last updated date/time
        const lastUpdated = document.getElementById('lastUpdated');
        if (lastUpdated) {
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            const dateStr = "2025-06-01";
            const timeStr = "14:25";
            lastUpdated.textContent = `Last updated: ${dateStr} ${timeStr}`;
        }
    </script>
    <!-- Changelog Modal -->
    <div id="changelogModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
      <div style="background:#222; color:#fff; padding:1.5em; border-radius:10px; max-width:650px; width:117vw; max-width:65vw; max-height:70vh; overflow:auto; box-shadow:0 4px 32px #000; position:relative;">
        <button id="closeChangelog" style="position:absolute; top:0.5em; right:0.5em; background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2 style="margin-top:0;">版本改动</h2>
        <div id="changelogContent" style="white-space:pre-wrap; background:#181818; padding:1em; border-radius:6px; max-height:50vh; overflow:auto; font-size:1em; font-family:inherit;">载入中...</div>
      </div>
    </div>
    <script>
    document.getElementById('changelogLink').addEventListener('click', function() {
      const modal = document.getElementById('changelogModal');
      modal.style.display = 'flex';
      fetch('https://anfneub.github.io/StellarOdysseySim/changelog.txt')
        .then(r => r.text())
        .then(txt => {
          // Format lines starting with '-' as list items
          const lines = txt.split('\n');
          let html = '';
          let inList = false;
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (/^\s*- /.test(line)) {
              if (!inList) { html += '<ul style="margin:0 0 0 1.5em; padding-left:1.2em;">'; inList = true; }
              html += '<li style="margin-bottom:0.2em;">' + line.replace(/^\s*- /, '') + '</li>';
            } else {
              if (inList) { html += '</ul>'; inList = false; }
              // If the line is not empty, wrap in <div>, else add a blank line
              html += line.trim() ? '<div>' + line + '</div>' : '<div style="height:0.7em;"></div>';
            }
          }
          if (inList) html += '</ul>';
          document.getElementById('changelogContent').innerHTML = html;
        })
        .catch(() => {
          document.getElementById('changelogContent').textContent = 'Could not load changelog.';
        });
    });
    document.getElementById('closeChangelog').addEventListener('click', function() {
      document.getElementById('changelogModal').style.display = 'none';
    });
    // Optional: close modal on outside click
    document.getElementById('changelogModal').addEventListener('click', function(e) {
      if (e.target === this) this.style.display = 'none';
    });
    </script>
    <script src="script.js"></script>
    <script src="universe_map.js"></script>
    <script type="module">
        // Import probability functions
        import { probability_of_observation_with_per_gatherable_qualities } from './probabilities.js';

        document.addEventListener('DOMContentLoaded', function() {
            // Declare variables at the top
            const nNodesType = document.getElementById('n_nodes_type');
            const nNodes = document.getElementById('n_nodes');
            const nGatherableType = document.getElementById('n_gatherable_type');
            const nGatherable = document.getElementById('n_gatherable');
            const nCategoriesType = document.getElementById('n_categories_type');
            const nCategories = document.getElementById('n_categories');
            const qualitySelections = document.getElementById('quality-selections');

            // Quality ranges based on the probabilities.js file
            const qualityRanges = [
                { label: "1-30", value: "1-30" },
                { label: "31-70", value: "31-70" },
                { label: "71-90", value: "71-90" },
                { label: "91-100", value: "91-100" }
            ];

            function updateQualitySelections() {
                const numGatherable = parseInt(nGatherable.value) || 0;
                const isAny = nGatherableType.value === 'any';
                
                // Keep the first selection row
                const firstSelection = qualitySelections.firstElementChild;
                qualitySelections.innerHTML = '';
                if (firstSelection) {
                    qualitySelections.appendChild(firstSelection);
                }
                
                if (isAny || numGatherable === 0) {
                    qualitySelections.style.display = 'none';
                    return;
                }

                qualitySelections.style.display = 'flex';

                // Add additional selections starting from index 1
                for (let i = 1; i < numGatherable; i++) {
                    const selectionDiv = document.createElement('div');
                    selectionDiv.className = 'form-row';
                    selectionDiv.style.marginBottom = '0';
                    selectionDiv.style.display = 'flex';
                    selectionDiv.style.alignItems = 'center';
                    selectionDiv.style.gap = '0.5em';
                    
                    const label = document.createElement('label');
                    label.textContent = `采集节点 ${i + 1} 质量：`;
                    label.style.color = '#e6eaf3';
                    label.style.minWidth = '180px';
                    
                    const select = document.createElement('select');
                    select.style.width = '8em';
                    select.style.background = '#36405a';
                    select.style.color = '#e6eaf3';
                    select.style.border = '1px solid #2c3242';
                    select.style.padding = '0.2em';
                    select.style.borderRadius = '4px';
                    
                    // Add "Any" option
                    const anyOption = document.createElement('option');
                    anyOption.value = 'any';
                    anyOption.textContent = '任意';
                    select.appendChild(anyOption);
                    
                    // Add quality range options
                    qualityRanges.forEach(range => {
                        const option = document.createElement('option');
                        option.value = range.value;
                        option.textContent = range.label;
                        select.appendChild(option);
                    });
                    
                    selectionDiv.appendChild(label);
                    selectionDiv.appendChild(select);
                    qualitySelections.appendChild(selectionDiv);
                }
            }

            function handleTypeChange(selectElement, inputElement) {
                const isAny = selectElement.value === 'any';
                inputElement.disabled = isAny;
                inputElement.readOnly = isAny;
                inputElement.style.background = isAny ? '#2c3242' : '#36405a';
                inputElement.style.cursor = isAny ? 'not-allowed' : 'text';
                inputElement.style.opacity = isAny ? '0.7' : '1';
                inputElement.style.pointerEvents = isAny ? 'none' : 'auto';
                
                // Update quality selections when gatherable type changes
                if (selectElement === nGatherableType) {
                    updateQualitySelections();
                }
            }

            // Add event listeners for type changes
            ['n_nodes_type', 'n_gatherable_type', 'n_categories_type'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.addEventListener('change', function() {
                        handleTypeChange(this, document.getElementById(id.replace('_type', '')));
                    });
                    // Set initial state
                    handleTypeChange(select, document.getElementById(id.replace('_type', '')));
                }
            });

            // Prevent input when disabled
            ['n_nodes', 'n_gatherable', 'n_categories'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('keydown', function(e) {
                        if (this.disabled) {
                            e.preventDefault();
                            return false;
                        }
                    });
                    input.addEventListener('input', function(e) {
                        if (this.disabled) {
                            e.preventDefault();
                            this.value = '';
                            return false;
                        }
                    });
                }
            });

            // Add input event listener for n_gatherable to update quality selections
            nGatherable.addEventListener('input', updateQualitySelections);

            // Set initial states
            handleTypeChange(nNodesType, nNodes);
            handleTypeChange(nGatherableType, nGatherable);
            handleTypeChange(nCategoriesType, nCategories);
            
            // Ensure quality selections are initialized
            updateQualitySelections();

            // Calculate probability
            document.getElementById('calculateProbabilityBtn').addEventListener('click', function() {
                const nNodes = document.getElementById('n_nodes_type').value === 'any' ? 'Any' : parseInt(document.getElementById('n_nodes').value);
                const nNodesType = document.getElementById('n_nodes_type').value;
                const nGatherable = document.getElementById('n_gatherable_type').value === 'any' ? 'Any' : parseInt(document.getElementById('n_gatherable').value);
                const nGatherableType = document.getElementById('n_gatherable_type').value;
                const nCategories = document.getElementById('n_categories_type').value === 'any' ? 'Any' : parseInt(document.getElementById('n_categories').value);
                const nCategoriesType = document.getElementById('n_categories_type').value;

                // Collect quality ranges from all quality selection dropdowns
                const qualityRanges = [];
                document.querySelectorAll('#quality-selections select').forEach(select => {
                    if (select.value === 'any') {
                        qualityRanges.push('Any');
                    } else {
                        const [start, end] = select.value.split('-').map(Number);
                        qualityRanges.push([start, end]);
                    }
                });

                // Calculate probability
                const inhabitedSystemValue = document.getElementById('inhabited_system').value;
                const inhabitedSystem = inhabitedSystemValue === 'any' ? null : inhabitedSystemValue === 'inhabited';
                
                const probability = probability_of_observation_with_per_gatherable_qualities(
                    nNodes,
                    nNodesType,
                    nGatherable,
                    nGatherableType,
                    nCategories,
                    nCategoriesType,
                    qualityRanges,
                    inhabitedSystem
                );

                // Format probability with more decimal places for small values
                const formatProbability = (prob) => {
                    if (prob < 0.001) {
                        return `${(prob * 100).toFixed(6)}%`;
                    }
                    return `${(prob * 100).toFixed(2)}%`;
                };

                // Calculate and format estimated number of systems
                const estimatedSystems = probability * 4000000;
                const formatEstimatedSystems = (num) => {
                    if (num < 0.1) {
                        return num.toFixed(6);
                    }
                    return num.toFixed(2);
                };

                // Display results
                document.getElementById('probability_value').textContent = formatProbability(probability);
                document.getElementById('estimated_systems').textContent = formatEstimatedSystems(estimatedSystems);
            });
        });
    </script>
</body>
</html> 
